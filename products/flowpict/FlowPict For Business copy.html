<!DOCTYPE html>
<html lang="id" class="scroll-smooth">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FlowPict - Empowering Your Business</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: {
                            light: '#a855f7', // Purple-500
                            dark: '#d946ef',  // Fuchsia-500
                            darker: '#7e22ce', // Purple-700
                        }
                    },
                    fontFamily: {
                        sans: ['Poppins', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <style>
        /* ... existing styles ... */
        body {
            font-family: 'Poppins', sans-serif;
            overflow-x: hidden;
            background-color: #F8FAFC;
            /* Slate-50 */
            color: #1E293B;
            /* Slate-800 */
        }

        .gradient-text {
            background: linear-gradient(135deg, #a855f7, #ec4899);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .sidebar-gradient {
            background: linear-gradient(180deg, #4c1d95 0%, #a855f7 100%);
        }

        #sidebar {
            transition: width 0.3s ease-in-out, transform 0.3s ease-in-out;
        }

        #main-content {
            transition: margin-left 0.3s ease-in-out;
        }

        .card {
            background-color: #FFFFFF;
            border: 1px solid #e2e8f0;
            transition: all 0.3s ease;
        }

        .selection-card {
            border: 2px solid #e2e8f0;
            transition: all 0.3s ease;
            background-color: #FFFFFF;
            position: relative;
        }

        .selection-card:hover {
            border-color: #d8b4fe;
        }

        .selection-card.selected {
            border-color: #a855f7;
            background-color: #faf5ff;
            /* purple-50 */
            box-shadow: 0 4px 20px rgba(168, 85, 247, 0.2);
            transform: translateY(-5px);
        }

        /* SVG Icon Styles */
        .icon-svg {
            width: 40px;
            height: 40px;
            stroke-width: 1.5;
            transition: all 0.3s ease;
            stroke: #64748b;
            /* slate-500 */
        }

        .selection-card.selected .icon-svg {
            stroke: #a855f7;
            transform: scale(1.1);
        }

        /* Tooltip Style */
        .tooltip {
            visibility: hidden;
            position: absolute;
            z-index: 50;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            width: 200px;
            background-color: #1e293b;
            color: #fff;
            text-align: center;
            border-radius: 8px;
            padding: 8px;
            font-size: 11px;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
            margin-bottom: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .tooltip::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #1e293b transparent transparent transparent;
        }

        .has-tooltip:hover .tooltip {
            visibility: visible;
            opacity: 1;
        }

        .info-icon:hover+.tooltip {
            visibility: visible;
            opacity: 1;
        }

        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #d8b4fe;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #a855f7;
        }

        .max-h-60vh {
            max-height: 60vh;
        }

        /* Sidebar Collapse Styles */
        @media (max-width: 768px) {
            #sidebar {
                transform: translateX(-100%);
                z-index: 50;
            }

            #sidebar.open {
                transform: translateX(0);
            }

            #overlay {
                display: none;
            }

            #overlay.active {
                display: block;
            }
        }

        @media (min-width: 769px) {
            #sidebar.collapsed {
                width: 5rem;
            }

            #sidebar.collapsed .menu-text {
                display: none;
            }

            #sidebar.collapsed .logo-text {
                display: none;
            }

            #sidebar.collapsed .menu-icon {
                margin-right: 0;
                margin: 0 auto;
            }

            #sidebar.collapsed .nav-item {
                justify-content: center;
                padding-left: 0;
                padding-right: 0;
            }

            #main-content.expanded {
                margin-left: 5rem;
            }
        }

        /* Animation for Edit Loading */
        @keyframes shimmer {
            0% {
                background-position: -1000px 0;
            }

            100% {
                background-position: 1000px 0;
            }
        }

        .loading-shimmer {
            animation: shimmer 2s infinite linear;
            background: linear-gradient(to right, #f6f7f8 4%, #edeef1 25%, #f6f7f8 36%);
            background-size: 1000px 100%;
        }

        /* Tab Styles for Ad Generator */
        .tab-btn {
            transition: all 0.3s ease;
        }

        .tab-btn.active {
            background: linear-gradient(135deg, #a855f7, #ec4899);
            color: white;
            border-color: transparent;
        }

        /* Edit Tab Styles */
        .edit-tab {
            @apply flex flex-col items-center justify-center p-3 rounded-xl font-medium text-xs transition-all cursor-pointer border h-full;
        }

        .edit-tab.active {
            @apply bg-purple-600 text-white border-purple-600 shadow-md transform scale-105;
        }

        .edit-tab.inactive {
            @apply bg-white text-slate-500 border-slate-200 hover:bg-slate-50 hover:border-purple-300;
        }

        .edit-tab.disabled {
            @apply bg-slate-50 text-slate-400 border-slate-100 cursor-not-allowed opacity-70;
        }

        /* Thumbnail Selected State */
        .thumb-selected {
            border-color: #a855f7;
            box-shadow: 0 0 0 2px #d8b4fe;
            opacity: 1;
        }

        .thumb-inactive {
            border-color: transparent;
            opacity: 0.6;
        }

        .thumb-inactive:hover {
            opacity: 0.9;
        }

        /* FlowMagic Special Styles */
        .magic-border {
            border: 2px solid transparent;
            background-image: linear-gradient(white, white), linear-gradient(135deg, #a855f7, #ec4899);
            background-origin: border-box;
            background-clip: content-box, border-box;
        }

        /* Sidebar Gradient */
        .sidebar-gradient {
            background: linear-gradient(180deg, #8b5cf6 0%, #d946ef 100%);
        }
    </style>
</head>

<body class="antialiased flex h-screen overflow-hidden">
    <!-- Mobile Overlay -->
    <div id="overlay" class="fixed inset-0 bg-black/50 z-40 lg:hidden"></div>

    <!-- SIDEBAR -->
    <aside id="sidebar" class="sidebar-gradient text-white w-64 flex flex-col fixed h-full shadow-2xl z-50">
        <!-- Logo Area -->
        <div class="p-6 flex items-center justify-between">
            <div class="flex items-center gap-3 overflow-hidden">
                <!-- LOGO FLOWPICT (Image) -->
                <div
                    class="w-12 h-12 bg-white rounded-xl flex items-center justify-center shadow-lg shrink-0 relative overflow-hidden group">
                    <img src="https://i.imgur.com/0IBMqub.png" alt="FlowPict Logo" class="w-full h-full object-cover"
                        onerror="this.style.display='none'; this.nextElementSibling.style.display='block'">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7 text-purple-600 hidden" fill="none"
                        viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" />
                    </svg>
                </div>

                <div class="flex flex-col logo-text justify-center">
                    <span class="font-bold text-xl tracking-tight whitespace-nowrap leading-none mb-1">FlowPict</span>
                    <span class="text-[9px] text-white/90 font-light tracking-wider uppercase leading-none">Empowering
                        Your Business</span>
                </div>
            </div>
            <button id="close-sidebar-mobile" class="lg:hidden text-white/80 hover:text-white">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                    stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>

        <!-- Menu Items -->
        <nav class="flex-1 px-4 space-y-2 mt-4 overflow-y-auto">
            <button onclick="switchView('home')"
                class="nav-item w-full flex items-center gap-4 px-4 py-3 rounded-xl hover:bg-white/10 transition-colors text-left group active-nav bg-white/20"
                title="Home">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 menu-icon shrink-0" fill="none"
                    viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
                </svg>
                <span class="menu-text font-medium">Home</span>
            </button>
            <button onclick="switchView('product')"
                class="nav-item w-full flex items-center gap-4 px-4 py-3 rounded-xl hover:bg-white/10 transition-colors text-left group"
                title="Ai Photography">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 menu-icon shrink-0" fill="none"
                    viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                </svg>
                <span class="menu-text font-medium">Ai Photography</span>
            </button>
            <button onclick="switchView('banner')"
                class="nav-item w-full flex items-center gap-4 px-4 py-3 rounded-xl hover:bg-white/10 transition-colors text-left group"
                title="Delivery Banner">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 menu-icon shrink-0" fill="none"
                    viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M11 5.882V19.24a1.76 1.76 0 01-3.417.592l-2.147-6.15M18 13a3 3 0 100-6M5.436 13.683A4.001 4.001 0 017 6h1.832c4.1 0 7.625-1.234 9.168-3v14c-1.543-1.766-5.067-3-9.168-3H7a3.988 3.988 0 01-1.564-.317z" />
                </svg>
                <span class="menu-text font-medium">Delivery Banner</span>
            </button>

            <!-- Magic design Feature -->
            <button onclick="switchView('flowmagic')"
                class="nav-item w-full flex items-center gap-4 px-4 py-3 rounded-xl hover:bg-white/10 transition-colors text-left group bg-gradient-to-r from-pink-500/20 to-purple-500/20 border border-white/10"
                title="Magic design">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 menu-icon shrink-0 text-yellow-300" fill="none"
                    viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M19.428 15.428a2 2 0 00-1.022-.547l-2.384-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z" />
                </svg>
                <span
                    class="menu-text font-bold bg-clip-text text-transparent bg-gradient-to-r from-yellow-200 to-pink-200">Magic
                    design ‚ú®</span>
            </button>

            <!-- Professional Ads (FROZEN) -->
            <button disabled
                class="nav-item w-full flex items-center gap-4 px-4 py-3 rounded-xl bg-white/5 opacity-70 cursor-not-allowed text-left group border border-white/5"
                title="Profesional Ads">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 menu-icon shrink-0" fill="none"
                    viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" />
                </svg>
                <div class="menu-text flex flex-col items-start leading-none">
                    <span class="font-medium">Profesional Ads</span>
                    <span
                        class="text-[9px] bg-white/20 px-1.5 py-0.5 rounded mt-1 text-white/90 font-bold tracking-wide">SOON</span>
                </div>
            </button>

            <!-- Affiliate Intelegence (Placehoder) -->
            <button disabled
                class="nav-item w-full flex items-center gap-4 px-4 py-3 rounded-xl bg-white/5 opacity-70 cursor-not-allowed text-left group border border-white/5"
                title="Affiliate Intelegence">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 menu-icon shrink-0" fill="none"
                    viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M13 10V3L4 14h7v7l9-11h-7z" />
                </svg>
                <div class="menu-text flex flex-col items-start leading-none">
                    <span class="font-medium">Affiliate Intelegence</span>
                    <span
                        class="text-[9px] bg-white/20 px-1.5 py-0.5 rounded mt-1 text-white/90 font-bold tracking-wide">SOON</span>
                </div>
            </button>

            <!-- Meta Ads Content (Placehoder) -->
            <button disabled
                class="nav-item w-full flex items-center gap-4 px-4 py-3 rounded-xl bg-white/5 opacity-70 cursor-not-allowed text-left group border border-white/5"
                title="Meta Ads Content">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 menu-icon shrink-0" fill="none"
                    viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M7 11.5V14m0-2.5v-6a1.5 1.5 0 113 0m-3 6a1.5 1.5 0 00-3 0v2a7.5 7.5 0 0015 0v-5a1.5 1.5 0 00-3 0m-6-3V11m0-5.5v-1a1.5 1.5 0 013 0v1m0 0V11" />
                </svg>
                <div class="menu-text flex flex-col items-start leading-none">
                    <span class="font-medium">Meta Ads Content</span>
                    <span
                        class="text-[9px] bg-white/20 px-1.5 py-0.5 rounded mt-1 text-white/90 font-bold tracking-wide">SOON</span>
                </div>
            </button>
        </nav>

        <!-- Footer Area -->
        <div class="p-4 mt-auto">
            <div class="bg-white/10 rounded-xl p-4 text-center menu-text">
                <p class="text-xs text-white/70 mb-1">Butuh bantuan?</p>
                <button
                    class="bg-white text-purple-600 px-4 py-1.5 rounded-full text-xs font-bold w-full hover:bg-purple-50 transition">Chat
                    Support</button>
            </div>
            <p class="text-[10px] text-center text-white/50 mt-4 logo-text">@ 2025 V3.0 FlowPict All Right Reserve</p>
        </div>
    </aside>

    <!-- MAIN CONTENT WRAPPER -->
    <div id="main-content" class="flex-1 flex flex-col h-full relative ml-0 md:ml-64 overflow-hidden">

        <!-- Top Header -->
        <header class="bg-white border-b border-slate-200 p-4 md:px-8 flex items-center justify-between shrink-0 h-16">
            <div class="flex items-center gap-4">
                <button id="sidebar-toggle"
                    class="text-slate-500 hover:text-purple-600 focus:outline-none p-2 rounded-lg hover:bg-slate-100 transition">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M4 6h16M4 12h16M4 18h16" />
                    </svg>
                </button>
                <h2 id="page-title" class="text-lg md:text-xl font-bold text-slate-800">Home</h2>
            </div>

            <div class="flex items-center gap-3">
                <button id="lang-toggle"
                    class="px-3 py-1.5 rounded-full bg-slate-100 text-xs font-bold border border-slate-200 text-slate-600">ID</button>
            </div>
        </header>

        <!-- Scrollable Content Area -->
        <div id="content-scroll-area" class="flex-1 overflow-y-auto p-4 md:p-8 scroll-smooth pb-24">

            <!-- VIEW: HOME -->
            <div id="view-home" class="space-y-6 max-w-4xl mx-auto animate-fade-in">
                <!-- Welcome Banner -->
                <div
                    class="bg-gradient-to-r from-purple-600 to-pink-500 rounded-2xl p-8 text-white shadow-xl relative overflow-hidden">
                    <div class="absolute top-0 right-0 w-64 h-64 bg-white/10 rounded-full -mr-16 -mt-16 blur-2xl"></div>
                    <div class="relative z-10">
                        <h1 class="text-3xl font-bold mb-2">Halo, Selamat Datang! üëã</h1>
                        <p class="text-purple-100 max-w-lg">Saya Flow Asisten Visual Designer, Siap bantu bisnis kamu
                            dengan visual yang menarik</p>
                    </div>
                </div>
            </div>



            <!-- VIEW: Ai Photography -->
            <div id="view-product" class="hidden space-y-8 max-w-5xl mx-auto animate-fade-in">
                <div class="text-center mb-8">
                    <h1 class="text-3xl md:text-4xl font-bold gradient-text mb-2">Ai Photography</h1>
                    <p class="text-slate-500">Buat foto katalog produk yang estetik dengan sentuhan AI profesional.
                    </p>
                </div>
                <div id="product-logic-container"></div>
            </div>

            <!-- VIEW: Delivery Banner -->
            <div id="view-banner" class="hidden space-y-8 max-w-5xl mx-auto animate-fade-in">
                <div class="text-center mb-8">
                    <h1 class="text-3xl md:text-4xl font-bold gradient-text mb-2">Delivery Banner</h1>
                    <p class="text-slate-500">Buat banner promosi untuk GrabFood, GoFood, ShopeeFood, Youtube,
                        Instagram
                        & TikTok.</p>
                </div>
                <div id="banner-logic-container"></div>
            </div>

            <!-- VIEW: Magic design -->
            <div id="view-flowmagic" class="hidden space-y-8 max-w-6xl mx-auto animate-fade-in">
                <div class="text-center mb-8">
                    <h1 class="text-3xl md:text-4xl font-bold gradient-text mb-2">Magic design ‚ú®</h1>
                    <p class="text-slate-500">Design Cloning: Buat desain sekelas profesional meniru gaya referensi
                        dengan produk Anda sendiri.</p>
                </div>
                <div id="flowmagic-logic-container"></div>
            </div>

            <!-- VIEW: Profesional Ads -->
            <div id="view-ad-video" class="hidden space-y-8 max-w-5xl mx-auto animate-fade-in">
                <div class="text-center mb-8">
                    <h1 class="text-3xl md:text-4xl font-bold gradient-text mb-2">Profesional Ads</h1>
                    <p class="text-slate-500">AI Director akan membuatkan storyboard, visual, dan naskah iklan
                        profesional untuk produk Anda.</p>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <!-- Left: Inputs -->
                    <div class="space-y-6">

                        <!-- Upload Section -->
                        <div class="space-y-4">
                            <!-- Ref Produk (Wajib, Max 5) -->
                            <div class="card rounded-2xl p-6 shadow-sm border-l-4 border-purple-500">
                                <label class="block text-sm font-bold text-slate-700 mb-3">1. Foto Produk (Max
                                    5)</label>
                                <div class="border-2 border-dashed border-slate-300 rounded-xl p-4 text-center cursor-pointer hover:border-purple-400 bg-slate-50 relative"
                                    onclick="document.getElementById('ad-product-input').click()">
                                    <input type="file" id="ad-product-input" class="hidden" accept="image/*" multiple
                                        onchange="handleAdProductUpload(this)">
                                    <div id="ad-product-prompt">
                                        <svg class="mx-auto h-6 w-6 text-slate-400 mb-2"
                                            xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                            stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M12 4v16m8-8H4" />
                                        </svg>
                                        <p class="text-xs text-slate-500">Upload hingga 5 Foto Produk</p>
                                    </div>
                                    <!-- Thumbnail Container -->
                                    <div id="ad-product-thumbs" class="hidden grid grid-cols-5 gap-2 mt-2"></div>
                                </div>
                            </div>

                            <!-- Ref Model (Opsional) -->
                            <div class="card rounded-2xl p-4 shadow-sm border-l-4 border-teal-500">
                                <label class="block text-sm font-bold text-slate-700 mb-2">2. Foto Model
                                    (Opsional)</label>
                                <div class="flex items-center gap-4">
                                    <div class="w-16 h-16 border-2 border-dashed border-slate-300 rounded-lg flex items-center justify-center cursor-pointer hover:border-teal-400 shrink-0"
                                        onclick="document.getElementById('ad-model-input').click()">
                                        <input type="file" id="ad-model-input" class="hidden" accept="image/*"
                                            onchange="handleAdModelUpload(this)">
                                        <div id="ad-model-prompt" class="text-center">
                                            <span class="text-xl text-slate-400">+</span>
                                        </div>
                                        <img id="ad-model-preview" class="hidden w-full h-full object-cover rounded-lg">
                                    </div>
                                    <p class="text-[10px] text-slate-500 flex-1">Upload foto talent/model jika ingin
                                        menggunakan karakter spesifik.</p>
                                </div>
                            </div>

                            <!-- Ref Lingkungan (Opsional) -->
                            <div class="card rounded-2xl p-4 shadow-sm border-l-4 border-orange-500">
                                <label class="block text-sm font-bold text-slate-700 mb-2">3. Foto Lingkungan
                                    (Opsional)</label>
                                <div class="flex items-center gap-4">
                                    <div class="w-16 h-16 border-2 border-dashed border-slate-300 rounded-lg flex items-center justify-center cursor-pointer hover:border-orange-400 shrink-0"
                                        onclick="document.getElementById('ad-env-input').click()">
                                        <input type="file" id="ad-env-input" class="hidden" accept="image/*"
                                            onchange="handleAdEnvUpload(this)">
                                        <div id="ad-env-prompt" class="text-center">
                                            <span class="text-xl text-slate-400">+</span>
                                        </div>
                                        <img id="ad-env-preview" class="hidden w-full h-full object-cover rounded-lg">
                                    </div>
                                    <p class="text-[10px] text-slate-500 flex-1">Ref background/lokasi (misal: Toko,
                                        Taman).</p>
                                </div>
                            </div>

                            <!-- 1. Industry Category -->
                            <div class="card rounded-2xl p-4 shadow-sm border-l-4 border-blue-500">
                                <label class="block text-sm font-bold text-slate-700 mb-2">4. Kategori Bisnis</label>
                                <select id="ad-industry"
                                    class="w-full p-3 rounded-xl border border-slate-300 bg-slate-50 text-slate-700 focus:ring-2 focus:ring-blue-500 outline-none">
                                    <option value="fnb">Kuliner / F&B (Makanan & Minuman)</option>
                                    <option value="fashion">Fashion & Clothing</option>
                                    <option value="beauty">Beauty & Skincare</option>
                                    <option value="gadget">Gadget & Elektronik</option>
                                    <option value="service">Jasa / Service (Travel, Kursus, dll)</option>
                                    <option value="retail">Produk Retail / Barang Sehari-hari</option>
                                </select>
                            </div>

                            <!-- 2. Video Theme -->
                            <div class="card rounded-2xl p-4 shadow-sm">
                                <label class="block text-sm font-bold text-slate-700 mb-2">5. Tema Video</label>
                                <div class="grid grid-cols-2 gap-3" id="ad-theme-grid">
                                    <!-- Themes injected via JS -->
                                </div>
                            </div>

                            <!-- 2b. Video Concept (Optional) -->
                            <div class="card rounded-2xl p-4 shadow-sm">
                                <label class="block text-sm font-bold text-slate-700 mb-2">6. Konsep Video</label>
                                <textarea id="ad-concept" rows="2"
                                    class="w-full p-3 rounded-xl border border-slate-300 bg-slate-50 text-slate-700 focus:ring-2 focus:ring-purple-500 outline-none text-sm"
                                    placeholder="Cth: Video yang ceria untuk anak muda, tojolkan ketahanan produk..."></textarea>
                            </div>

                            <!-- 3. Scene Count -->
                            <div class="card rounded-2xl p-4 shadow-sm">
                                <label class="block text-sm font-bold text-slate-700 mb-2">7. Jumlah Scene</label>
                                <div class="grid grid-cols-3 gap-2">
                                    <label class="cursor-pointer">
                                        <input type="radio" name="scene-count" value="3" class="peer sr-only">
                                        <div
                                            class="p-3 rounded-xl border border-slate-200 text-center peer-checked:bg-purple-50 peer-checked:border-purple-500 peer-checked:text-purple-700 hover:bg-slate-50 transition">
                                            <span class="font-bold block">3 Scene</span>
                                            <span class="text-[10px] text-slate-500">~25 Detik</span>
                                        </div>
                                    </label>
                                    <label class="cursor-pointer">
                                        <input type="radio" name="scene-count" value="5" checked class="peer sr-only">
                                        <div
                                            class="p-3 rounded-xl border border-slate-200 text-center peer-checked:bg-purple-50 peer-checked:border-purple-500 peer-checked:text-purple-700 hover:bg-slate-50 transition">
                                            <span class="font-bold block">5 Scene</span>
                                            <span class="text-[10px] text-slate-500">~40 Detik</span>
                                        </div>
                                    </label>
                                    <label class="cursor-pointer">
                                        <input type="radio" name="scene-count" value="8" class="peer sr-only">
                                        <div
                                            class="p-3 rounded-xl border border-slate-200 text-center peer-checked:bg-purple-50 peer-checked:border-purple-500 peer-checked:text-purple-700 hover:bg-slate-50 transition">
                                            <span class="font-bold block">8 Scene</span>
                                            <span class="text-[10px] text-slate-500">~60 Detik</span>
                                        </div>
                                    </label>
                                </div>
                            </div>

                            <!-- 3. Ratio -->
                            <div class="card rounded-2xl p-4 shadow-sm">
                                <label class="block text-sm font-bold text-slate-700 mb-2">8. Ukuran Video</label>
                                <div class="grid grid-cols-3 gap-2">
                                    <div onclick="selectAdRatio('9:16')" id="ratio-9-16"
                                        class="ratio-card selected p-3 border rounded-xl text-center cursor-pointer hover:bg-slate-50 border-purple-500 bg-purple-50">
                                        <div class="text-xs font-bold mb-1">9:16</div>
                                        <div class="text-[10px] text-slate-500">TikTok/Reels</div>
                                    </div>
                                    <div onclick="selectAdRatio('16:9')" id="ratio-16-9"
                                        class="ratio-card p-3 border rounded-xl border-slate-200 text-center cursor-pointer hover:bg-slate-50">
                                        <div class="text-xs font-bold mb-1">16:9</div>
                                        <div class="text-[10px] text-slate-500">YouTube</div>
                                    </div>
                                    <div onclick="selectAdRatio('1:1')" id="ratio-1-1"
                                        class="ratio-card p-3 border rounded-xl border-slate-200 text-center cursor-pointer hover:bg-slate-50">
                                        <div class="text-xs font-bold mb-1">1:1</div>
                                        <div class="text-[10px] text-slate-500">Feed IG</div>
                                    </div>
                                </div>
                            </div>

                            <button onclick="generateVideoAd()" id="btn-gen-video"
                                class="w-full py-4 rounded-xl font-bold text-white shadow-lg bg-gradient-to-r from-red-500 to-pink-600 hover:scale-[1.02] transition-transform flex items-center justify-center gap-2 text-lg">
                                <span class="animate-pulse">üë®‚Äçüé®</span>
                                <span>Generate Creative Assets</span>
                            </button>
                        </div>
                    </div>

                    <!-- Right: Video Result -->
                    <div class="space-y-6">
                        <!-- Placeholder State (Default) -->
                        <div id="ad-placeholder-result"
                            class="flex flex-col items-center justify-center p-12 bg-slate-50 rounded-2xl border-2 border-dashed border-slate-200 min-h-[400px]">
                            <span class="text-6xl mb-4">üé¨</span>
                            <h3 class="text-xl font-bold text-slate-400">Creative Director Output</h3>
                            <p class="text-slate-400 text-center max-w-xs mt-2">Storyboard, Visual Scenes, dan Aset JSON
                                akan muncul di sini.</p>
                        </div>
                        <!-- Loading State -->
                        <div id="video-loading"
                            class="hidden flex flex-col items-center justify-center p-12 bg-white rounded-2xl shadow-sm border border-slate-100 min-h-[400px]">
                            <div class="relative w-24 h-24 mb-6">
                                <div class="absolute inset-0 border-4 border-slate-100 rounded-full"></div>
                                <div
                                    class="absolute inset-0 border-4 border-purple-500 border-t-transparent rounded-full animate-spin">
                                </div>
                                <div class="absolute inset-0 flex items-center justify-center font-bold text-purple-600 text-sm"
                                    id="progress-percent">0%</div>
                            </div>
                            <h3 class="text-xl font-bold text-slate-800 mb-2" id="loading-stage">Menyiapkan
                                Konsep...</h3>
                            <p class="text-sm text-slate-500 text-center max-w-xs" id="loading-detail">AI Creative
                                Director sedang bekerja...</p>
                        </div>

                        <!-- Result State: SCENE GRID -->
                        <div id="video-result" class="hidden space-y-6">
                            <div class="flex items-center justify-between">
                                <h3 class="font-bold text-slate-800 flex items-center gap-2">
                                    <span class="text-xl">‚ú®</span> Hasil Produksi Kreatif
                                </h3>
                                <div class="flex gap-2">
                                    <button onclick="downloadAllAdAssets()"
                                        class="text-xs bg-slate-100 px-3 py-1.5 rounded-lg font-bold text-slate-600 hover:bg-slate-200">Download
                                        All</button>
                                </div>
                            </div>

                            <!-- SCENE GRID CONTAINER -->
                            <div id="ad-scenes-grid" class="grid grid-cols-1 gap-6"></div>

                            <!-- NARRATION & KIT -->
                            <div class="card p-5 rounded-2xl shadow-sm border-l-4 border-purple-500 bg-purple-50/50">
                                <h4 class="font-bold text-slate-700 mb-2 text-sm uppercase tracking-wide">Narration &
                                    Audio</h4>
                                <p class="text-xs text-slate-500 mb-3">Gunakan audio ini untuk voiceover video Anda.</p>

                                <div class="bg-white p-3 rounded-lg text-sm text-slate-600 italic leading-relaxed border border-slate-100 max-h-32 overflow-y-auto mb-4 font-serif"
                                    id="ad-script-text"></div>

                                <button onclick="downloadAdNarration()"
                                    class="w-full bg-white text-purple-600 px-4 py-2 rounded-lg font-bold text-sm shadow hover:bg-purple-50 border border-purple-200 flex items-center justify-center gap-2">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none"
                                        viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M19 14l-7 7m0 0l-7-7m7 7V3" />
                                    </svg>
                                    Download Naskah & Audio
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- VIEW: Magic Editor -->
    <div id="view-edit-photo" class="hidden space-y-8 max-w-6xl mx-auto animate-fade-in">
        <div class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold gradient-text mb-2">Magic Editor</h1>
            <p class="text-slate-500">Pilih alat AI yang ingin Anda gunakan.</p>
        </div>

        <!-- Tab Navigation / Toolbox -->
        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-3 mb-8">

            <!-- 1. Ubah Angel (Soon) -->
            <button class="edit-tab disabled relative h-20">
                <span class="text-2xl mb-1">%uD83D%uDD04</span>
                Ubah Angle
                <span
                    class="absolute top-1 right-1 bg-yellow-100 text-yellow-700 text-[8px] px-1.5 py-0.5 rounded-full border border-yellow-200 font-bold uppercase tracking-wider">Coming
                    Soon</span>
            </button>

            <!-- 2. Ubah Pose -->
            <button onclick="switchEditMode('pose')" id="tab-pose" class="edit-tab inactive relative h-20">
                <span class="text-2xl mb-1">%uD83E%uDDD8%u200D%u2640%uFE0F</span>
                Ubah Pose
                <span
                    class="absolute top-1 right-1 bg-green-100 text-green-700 text-[8px] px-1.5 py-0.5 rounded-full border border-green-200 font-bold uppercase tracking-wider">Ready</span>
            </button>

            <!-- 3. Detailing Wajah (Soon) -->
            <button class="edit-tab disabled relative h-20">
                <span class="text-2xl mb-1">%uD83D%uDC71%u200D%u2640%uFE0F</span>
                Detailing Wajah
                <span
                    class="absolute top-1 right-1 bg-yellow-100 text-yellow-700 text-[8px] px-1.5 py-0.5 rounded-full border border-yellow-200 font-bold uppercase tracking-wider">Coming
                    Soon</span>
            </button>

            <!-- 4. Buat Foto Carousel (Soon) -->
            <button class="edit-tab disabled relative h-20">
                <span class="text-2xl mb-1">%uD83C%uDF9E%uFE0F</span>
                Buat Foto Carousel
                <span
                    class="absolute top-1 right-1 bg-yellow-100 text-yellow-700 text-[8px] px-1.5 py-0.5 rounded-full border border-yellow-200 font-bold uppercase tracking-wider">Coming
                    Soon</span>
            </button>

            <!-- 5. Buat Mockup (Soon) -->
            <button class="edit-tab disabled relative h-20">
                <span class="text-2xl mb-1">%uD83D%uDCF1</span>
                Buat Mockup
                <span
                    class="absolute top-1 right-1 bg-yellow-100 text-yellow-700 text-[8px] px-1.5 py-0.5 rounded-full border border-yellow-200 font-bold uppercase tracking-wider">Coming
                    Soon</span>
            </button>

            <!-- 6. Hapus Background -->
            <button onclick="switchEditMode('bg')" id="tab-bg" class="edit-tab inactive relative h-20">
                <span class="text-2xl mb-1">%uD83E%uDE84</span>
                Hapus Background
                <span
                    class="absolute top-1 right-1 bg-green-100 text-green-700 text-[8px] px-1.5 py-0.5 rounded-full border border-green-200 font-bold uppercase tracking-wider">Ready</span>
            </button>

            <!-- 7. Face Swap (Soon) -->
            <button class="edit-tab disabled relative h-20">
                <span class="text-2xl mb-1">%uD83C%uDFAD</span>
                Face Swap
                <span
                    class="absolute top-1 right-1 bg-yellow-100 text-yellow-700 text-[8px] px-1.5 py-0.5 rounded-full border border-yellow-200 font-bold uppercase tracking-wider">Coming
                    Soon</span>
            </button>

            <!-- 8. Detailing Foto (Soon) -->
            <button class="edit-tab disabled relative h-20">
                <span class="text-2xl mb-1">%uD83D%uDD0E</span>
                Detailing Foto
                <span
                    class="absolute top-1 right-1 bg-yellow-100 text-yellow-700 text-[8px] px-1.5 py-0.5 rounded-full border border-yellow-200 font-bold uppercase tracking-wider">Coming
                    Soon</span>
            </button>

            <!-- 9. Edit Foto Manual (Soon) -->
            <button class="edit-tab disabled relative h-20">
                <span class="text-2xl mb-1">%uD83C%uDFA8</span>
                Edit Foto Manual
                <span
                    class="absolute top-1 right-1 bg-yellow-100 text-yellow-700 text-[8px] px-1.5 py-0.5 rounded-full border border-yellow-200 font-bold uppercase tracking-wider">Coming
                    Soon</span>
            </button>

            <!-- 10. Perluas Foto (Soon) -->
            <button class="edit-tab disabled relative h-20">
                <span class="text-2xl mb-1">%uD83D%uDCD0</span>
                Perluas Foto
                <span
                    class="absolute top-1 right-1 bg-yellow-100 text-yellow-700 text-[8px] px-1.5 py-0.5 rounded-full border border-yellow-200 font-bold uppercase tracking-wider">Coming
                    Soon</span>
            </button>
        </div>

        <!-- PLACEHOLDER INTRO -->
        <div id="edit-intro-placeholder"
            class="flex flex-col items-center justify-center py-20 bg-white rounded-2xl border-2 border-dashed border-slate-200 text-center animate-fade-in">
            <span class="text-6xl mb-6 block animate-bounce">%uD83D%uDC46</span>
            <h3 class="text-2xl font-bold text-slate-700">Pilih Magic Tool Anda</h3>
            <p class="text-slate-500 mt-2 max-w-md">Silakan klik salah satu fitur di atas untuk mulai
                mengedit
                foto.</p>
        </div>

        <!-- MODE: UBAH POSE -->
        <div id="edit-mode-pose" class="hidden grid grid-cols-1 md:grid-cols-2 gap-8">
            <!-- Input Section -->
            <div class="space-y-6">
                <div class="card rounded-2xl p-6 shadow-sm border-l-4 border-purple-500">
                    <label class="block text-sm font-bold text-slate-700 mb-3">1. Upload Foto Asli</label>
                    <div class="border-2 border-dashed border-slate-300 rounded-xl p-8 text-center cursor-pointer hover:border-purple-400 bg-slate-50 relative"
                        onclick="document.getElementById('edit-pose-input').click()">
                        <input type="file" id="edit-pose-input" class="hidden" accept="image/*"
                            onchange="handleEditPoseUpload(this)">
                        <div id="edit-pose-prompt">
                            <svg class="mx-auto h-10 w-10 text-slate-400 mb-3" xmlns="http://www.w3.org/2000/svg"
                                fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                                    d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                            </svg>
                            <p class="text-slate-600 font-medium text-sm">Klik atau seret foto ke sini</p>
                        </div>
                        <img id="edit-pose-preview" src=""
                            class="hidden max-h-64 mx-auto rounded shadow-sm object-contain">
                    </div>
                </div>

                <div class="card rounded-2xl p-6 shadow-sm">
                    <label class="block text-sm font-bold text-slate-700 mb-3">2. Deskripsi Pose
                        Baru</label>
                    <textarea id="edit-pose-desc" rows="3"
                        class="w-full p-3 rounded-xl border border-slate-300 bg-slate-50 focus:ring-2 focus:ring-purple-500 outline-none text-slate-700 text-sm"
                        placeholder="Contoh: Model sedang duduk di kursi kayu sambil memegang cangkir kopi..."></textarea>
                    <div class="bg-blue-50 p-3 rounded-lg flex gap-3 items-start mt-3">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-blue-600 mt-0.5 shrink-0"
                            fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <p class="text-xs text-blue-700">Berikan deskripsi yang detail untuk hasil terbaik.
                        </p>
                    </div>
                </div>
                <button onclick="generateEditPose()" id="btn-gen-pose"
                    class="w-full py-4 rounded-xl font-bold text-white shadow-lg bg-gradient-to-r from-purple-600 to-indigo-600 hover:scale-[1.02] transition transform disabled:opacity-50 flex items-center justify-center gap-2">
                    <span>%u2728 Generate Pose Baru</span>
                </button>
            </div>

            <!-- Result Section -->
            <div class="flex flex-col h-full">
                <div id="pose-loading"
                    class="hidden flex-1 flex flex-col items-center justify-center p-12 bg-white rounded-2xl shadow-sm border border-slate-100 min-h-[400px]">
                    <div
                        class="animate-spin w-12 h-12 border-4 border-purple-500 border-t-transparent rounded-full mb-4">
                    </div>
                    <p class="text-slate-500 font-medium">AI sedang memproses pose baru...</p>
                </div>

                <div id="pose-result-container"
                    class="hidden card rounded-2xl p-4 shadow-lg border border-purple-100 bg-white h-full flex flex-col">
                    <h3 class="font-bold text-slate-800 mb-4 flex items-center gap-2">
                        <span class="text-xl">%uD83D%uDCF8</span> Hasil Edit
                    </h3>
                    <div
                        class="relative flex-1 bg-slate-100 rounded-xl overflow-hidden flex items-center justify-center group">
                        <img id="pose-final-image" src="" class="max-w-full max-h-[500px] object-contain shadow-md">
                        <div
                            class="absolute inset-0 bg-black/60 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center gap-4">
                            <button onclick="downloadImageDirect(document.getElementById('pose-final-image').src)"
                                class="bg-white text-slate-800 px-4 py-2 rounded-full font-bold text-sm shadow hover:bg-slate-100 flex items-center gap-2">Download</button>
                        </div>
                    </div>
                </div>

                <div id="pose-placeholder"
                    class="flex-1 flex flex-col items-center justify-center p-8 bg-slate-50 rounded-2xl border-2 border-dashed border-slate-200 min-h-[400px]">
                    <span class="text-4xl mb-4">%uD83E%uDDD8%u200D%u2640%uFE0F</span>
                    <h3 class="font-bold text-slate-400">Hasil Pose Baru</h3>
                    <p class="text-sm text-slate-400 mt-2 text-center">Silakan upload foto dan tulis
                        deskripsi
                        pose di sebelah kiri.</p>
                </div>
            </div>
        </div>

        <!-- MODE: HAPUS BACKGROUND -->
        <div id="edit-mode-bg" class="hidden grid grid-cols-1 md:grid-cols-2 gap-8">
            <!-- Input Section -->
            <div class="space-y-6">
                <div class="card rounded-2xl p-6 shadow-sm border-l-4 border-teal-500">
                    <div class="flex items-start gap-3 mb-4 bg-teal-50 p-3 rounded-lg border border-teal-100">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-teal-600 flex-shrink-0 mt-0.5"
                            fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <p class="text-xs text-teal-800">
                            <strong>Cara Pakai:</strong> Upload foto, AI akan otomatis menghapus background.
                            Pilih warna pengganti di bawah.
                        </p>
                    </div>
                    <label class="block text-sm font-bold text-slate-700 mb-3">Upload Foto</label>
                    <div class="border-2 border-dashed border-slate-300 rounded-xl p-8 text-center cursor-pointer hover:border-teal-400 bg-slate-50 relative"
                        onclick="document.getElementById('bg-image-input').click()">
                        <input type="file" id="bg-image-input" class="hidden" accept="image/*"
                            onchange="handleBgImageUpload(this)">
                        <div id="bg-upload-prompt">
                            <svg class="mx-auto h-10 w-10 text-slate-400 mb-3" xmlns="http://www.w3.org/2000/svg"
                                fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                                    d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                            </svg>
                            <p class="text-slate-600 font-medium text-sm">Klik atau seret foto ke sini</p>
                        </div>
                        <img id="bg-preview-img" src=""
                            class="hidden max-h-64 mx-auto rounded shadow-sm object-contain">
                    </div>
                </div>

                <div class="card rounded-2xl p-6 shadow-sm">
                    <h3 class="font-semibold text-slate-800 mb-3">Pilih Background Baru</h3>
                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="selectBgOption('white')" id="bg-opt-white"
                            class="bg-option border-2 p-3 rounded-lg flex items-center gap-2 hover:bg-slate-50 transition">
                            <div class="w-6 h-6 rounded bg-white border border-gray-300 shadow-sm"></div>
                            <span class="text-sm font-medium text-slate-700">Putih (Solid)</span>
                        </button>
                        <button onclick="selectBgOption('black')" id="bg-opt-black"
                            class="bg-option border-2 p-3 rounded-lg flex items-center gap-2 hover:bg-slate-50 transition">
                            <div class="w-6 h-6 rounded bg-black shadow-sm"></div>
                            <span class="text-sm font-medium text-slate-700">Hitam (Solid)</span>
                        </button>
                        <button onclick="selectBgOption('transparent')" id="bg-opt-transparent"
                            class="bg-option border-2 p-3 rounded-lg flex items-center gap-2 hover:bg-slate-50 transition border-teal-500 bg-teal-50">
                            <div class="w-6 h-6 rounded border border-gray-300 bg-white"
                                style="background-image: linear-gradient(45deg, #ccc 25%, transparent 25%, transparent 75%, #ccc 75%, #ccc), linear-gradient(45deg, #ccc 25%, transparent 25%, transparent 75%, #ccc 75%, #ccc); background-size: 8px 8px;">
                            </div>
                            <span class="text-sm font-medium text-slate-700">Transparan*</span>
                        </button>
                        <div class="relative">
                            <button onclick="document.getElementById('custom-bg-color').click()"
                                class="bg-option w-full border-2 p-3 rounded-lg flex items-center gap-2 hover:bg-slate-50 transition">
                                <div id="custom-color-preview" class="w-6 h-6 rounded border border-gray-300 shadow-sm"
                                    style="background-color: #14b8a6;"></div>
                                <span class="text-sm font-medium text-slate-700">Custom</span>
                            </button>
                            <input type="color" id="custom-bg-color" class="absolute inset-0 opacity-0 cursor-pointer"
                                value="#14b8a6" onchange="updateCustomColor(this.value)">
                        </div>
                    </div>
                </div>

                <button onclick="generateRemoveBg()" id="btn-gen-bg"
                    class="w-full py-4 rounded-xl font-bold text-white shadow-lg bg-gradient-to-r from-teal-500 to-cyan-500 hover:scale-[1.02] transition transform disabled:opacity-50 flex items-center justify-center gap-2">
                    <span>%uD83E%uDE84 Hapus Background</span>
                </button>
            </div>

            <!-- Result Section -->
            <div class="flex flex-col h-full">
                <div id="bg-loading"
                    class="hidden flex-1 flex flex-col items-center justify-center p-12 bg-white rounded-2xl shadow-sm border border-slate-100 min-h-[400px]">
                    <div class="animate-spin w-12 h-12 border-4 border-teal-500 border-t-transparent rounded-full mb-4">
                    </div>
                    <p class="text-slate-500 font-medium">AI sedang menghapus background...</p>
                </div>

                <div id="bg-result-container"
                    class="hidden card rounded-2xl p-4 shadow-lg border border-teal-100 bg-white h-full flex flex-col">
                    <h3 class="font-bold text-slate-800 mb-4 flex items-center gap-2">
                        <span class="text-xl">%uD83D%uDDBC%uFE0F</span> Hasil Akhir
                    </h3>
                    <div class="relative flex-1 rounded-xl overflow-hidden flex items-center justify-center group"
                        id="bg-result-wrapper"
                        style="background-image: linear-gradient(45deg, #ccc 25%, transparent 25%, transparent 75%, #ccc 75%, #ccc), linear-gradient(45deg, #ccc 25%, transparent 25%, transparent 75%, #ccc 75%, #ccc); background-size: 10px 10px; background-color: #f3f4f6;">
                        <img id="bg-final-image" src="" class="max-w-full max-h-[500px] object-contain shadow-md">
                        <div
                            class="absolute inset-0 bg-black/60 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center gap-4">
                            <button onclick="downloadImageDirect(document.getElementById('bg-final-image').src)"
                                class="bg-white text-slate-800 px-4 py-2 rounded-full font-bold text-sm shadow hover:bg-slate-100 flex items-center gap-2">Download
                                PNG</button>
                        </div>
                    </div>
                </div>

                <div id="bg-placeholder"
                    class="flex-1 flex flex-col items-center justify-center p-8 bg-slate-50 rounded-2xl border-2 border-dashed border-slate-200 min-h-[400px]">
                    <span class="text-4xl mb-4">%u2B1C</span>
                    <h3 class="font-bold text-slate-400">Hasil Hapus Background</h3>
                    <p class="text-sm text-slate-400 mt-2 text-center">Silakan upload foto & pilih warna
                        background di kiri.</p>
                </div>
            </div>
        </div>
    </div>
    </div>
    </div>
    </div>

    <!-- JSON PROMPT MODAL -->
    <div id="json-prompt-modal" class="fixed inset-0 z-[60] hidden">
        <div class="absolute inset-0 bg-black/80 backdrop-blur-sm" onclick="closeJsonPromptModal()"></div>
        <div
            class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-full max-w-lg bg-white rounded-2xl shadow-2xl overflow-hidden animate-fade-in m-4">
            <div class="p-4 border-b border-slate-100 flex items-center justify-between bg-purple-50">
                <h3 class="font-bold text-slate-800 flex items-center gap-2">
                    <span class="text-xl">üìã</span> JSON Prompt
                </h3>
                <button onclick="closeJsonPromptModal()" class="text-slate-400 hover:text-slate-600">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>

            <div class="p-6 space-y-4">
                <div class="bg-slate-50 p-4 rounded-xl border border-slate-200">
                    <p class="text-xs text-slate-500 mb-2 font-bold uppercase tracking-wider">Prompt for
                        Runway/Luma/Kling:</p>
                    <pre id="json-prompt-content"
                        class="text-xs text-slate-700 font-mono whitespace-pre-wrap break-words h-64 overflow-y-auto"></pre>
                </div>

                <button onclick="copyToClipboard(document.getElementById('json-prompt-content').innerText)"
                    class="w-full bg-purple-600 text-white py-3 rounded-xl font-bold shadow hover:bg-purple-700 transition flex items-center justify-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3" />
                    </svg>
                    Copy JSON
                </button>
            </div>
        </div>
    </div>

    <!-- PREVIEW MODAL -->
    <div id="preview-modal"
        class="fixed inset-0 bg-black/90 backdrop-blur-sm flex items-center justify-center z-[60] hidden"
        onclick="closePreviewModal()">
        <button class="absolute top-4 right-4 text-white hover:text-red-400 p-2">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24"
                stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
        </button>
        <img id="preview-image-full" src="" alt="Full Preview"
            class="max-w-[90vw] max-h-[90vh] object-contain rounded-lg shadow-2xl">
    </div>

    <!-- EDIT MODAL -->
    <div id="edit-modal"
        class="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center md:p-4 z-[55] hidden transition-all">
        <div id="edit-modal-content"
            class="bg-white md:rounded-2xl w-full md:max-w-4xl h-full md:h-[90vh] flex flex-col md:flex-row overflow-hidden shadow-2xl transition-all duration-300">
            <!-- Left: Image Preview -->
            <div
                class="w-full md:w-auto md:flex-1 bg-slate-900 flex items-center justify-center p-4 relative group h-[40%] md:h-full">
                <img id="edit-source-img" src="" class="max-w-full max-h-full object-contain">
                <div id="edit-loading"
                    class="absolute inset-0 bg-black/70 flex flex-col items-center justify-center hidden">
                    <div
                        class="animate-spin w-12 h-12 border-4 border-purple-500 border-t-transparent rounded-full mb-4">
                    </div>
                    <p class="text-white font-medium">Sedang memproses edit...</p>
                </div>
            </div>

            <!-- Right: Controls -->
            <div class="w-full md:w-96 bg-white p-4 md:p-6 flex flex-col border-l border-slate-200 h-[60%] md:h-full">
                <div class="flex justify-between items-center mb-4 md:mb-6 shrink-0">
                    <h3 class="text-lg md:text-xl font-bold text-slate-800">Magic Editor</h3>
                    <div class="flex gap-2">
                        <button onclick="toggleModalFullScreen()"
                            class="text-slate-400 hover:text-purple-600 p-1 rounded hover:bg-slate-100"
                            title="Full Screen">
                            <svg id="icon-maximize" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none"
                                viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4" />
                            </svg>
                            <svg id="icon-minimize" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 hidden"
                                fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M10 14H6m0 0v4m0-4l5-5m7 5h4m0 0v4m0-4l-5-5m-5-5l5 5m0 0h-4m4 0v-4m5 5l-5-5m5 5v-4m0 4h4" />
                            </svg>
                        </button>
                        <button onclick="closeEditModal()"
                            class="text-slate-400 hover:text-red-500 p-1 rounded hover:bg-slate-100">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>
                </div>

                <div class="flex-1 space-y-4 overflow-y-auto pr-2">
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-2">Apa yang ingin
                            diubah?</label>
                        <textarea id="edit-prompt-input" rows="4"
                            class="w-full p-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-purple-500 outline-none text-sm"
                            placeholder="Contoh: Ganti background jadi warna merah, rubah tulisan order now jadi pesan sekarang..."></textarea>
                    </div>

                    <div class="bg-blue-50 p-3 rounded-lg flex gap-3 items-start">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-blue-600 mt-0.5 shrink-0"
                            fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <p class="text-xs text-blue-700">Fitur ini mempertahankan komposisi asli.</p>
                    </div>
                </div>

                <div class="mt-auto pt-3 border-t border-slate-100 space-y-2 shrink-0">
                    <button onclick="processEdit()"
                        class="w-full py-3 bg-purple-600 hover:bg-purple-700 text-white rounded-xl font-bold shadow-lg transition flex items-center justify-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                        </svg>
                        Generate Edit
                    </button>
                    <button onclick="saveEditedImage()" id="btn-save-edit"
                        class="w-full py-3 bg-green-500 hover:bg-green-600 text-white rounded-xl font-bold shadow-lg transition hidden">
                        Simpan Hasil Edit
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- NEW: SOCIAL KIT MODAL -->
    <div id="social-kit-modal"
        class="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-[70] hidden p-4">
        <div class="bg-white rounded-2xl w-full max-w-6xl overflow-hidden shadow-2xl animate-fade-in">
            <div class="bg-gradient-to-r from-purple-600 to-pink-500 p-6 text-white flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-white/20 rounded-lg flex items-center justify-center">%u2728
                    </div>
                    <div>
                        <h3 class="font-bold text-lg leading-tight">Viral Social Kit</h3>
                        <p class="text-xs text-white/80">Caption & Hashtag Teroptimasi AI</p>
                    </div>
                </div>
                <button onclick="closeSocialKitModal()" class="text-white/80 hover:text-white">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>

            <div class="p-6 space-y-6">
                <div id="social-kit-loading" class="hidden flex flex-col items-center justify-center py-10">
                    <div
                        class="animate-spin w-10 h-10 border-4 border-purple-500 border-t-transparent rounded-full mb-4">
                    </div>
                    <p class="text-slate-500 text-sm font-medium">Asisten Sosmed sedang menulis...</p>
                </div>

                <div id="social-kit-content" class="space-y-4">
                    <div>
                        <div class="flex justify-between items-center mb-2">
                            <label class="text-xs font-bold text-slate-400 uppercase tracking-wider">Viral
                                Caption</label>
                            <button onclick="copyToClipboard(document.getElementById('viral-caption-text').innerText)"
                                class="text-[10px] bg-purple-100 text-purple-600 px-2 py-1 rounded font-bold hover:bg-purple-200 transition">Copy
                                Caption</button>
                        </div>
                        <div id="viral-caption-text"
                            class="bg-slate-50 p-4 rounded-xl border border-slate-200 text-sm text-slate-700 leading-relaxed whitespace-pre-wrap min-h-[100px]">
                        </div>
                    </div>

                    <div>
                        <div class="flex justify-between items-center mb-2">
                            <label class="text-xs font-bold text-slate-400 uppercase tracking-wider">Viral
                                Hashtags</label>
                            <button onclick="copyToClipboard(document.getElementById('viral-hashtag-text').innerText)"
                                class="text-[10px] bg-pink-100 text-pink-600 px-2 py-1 rounded font-bold hover:bg-pink-200 transition">Copy
                                Hashtags</button>
                        </div>
                        <div id="viral-hashtag-text"
                            class="bg-slate-50 p-4 rounded-xl border border-slate-200 text-sm text-pink-600 font-medium whitespace-pre-wrap">
                        </div>
                    </div>
                </div>
            </div>

            <div class="p-4 bg-slate-50 border-t border-slate-100 text-center">
                <button onclick="closeSocialKitModal()"
                    class="w-full py-3 bg-white border border-slate-200 text-slate-600 rounded-xl text-sm font-bold shadow-sm hover:bg-slate-100 transition">Tutup</button>
            </div>
        </div>
    </div>

    <!-- NEW: MOTION MODAL -->
    <div id="motion-modal"
        class="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-[70] hidden p-4">
        <div class="bg-white rounded-2xl w-full max-w-6xl overflow-hidden shadow-2xl animate-fade-in">
            <div class="bg-gradient-to-r from-blue-600 to-indigo-600 p-6 text-white flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-white/20 rounded-lg flex items-center justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" />
                        </svg>
                    </div>
                    <div>
                        <h3 class="font-bold text-lg leading-tight">Motion Suggestion</h3>
                        <p class="text-xs text-white/80">Saran Pergerakan Kamera (Cinematography)</p>
                    </div>
                </div>
                <button onclick="closeMotionModal()" class="text-white/80 hover:text-white">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <div class="p-6 space-y-6">
                <div id="motion-loading" class="hidden flex flex-col items-center justify-center py-10">
                    <div class="animate-spin w-10 h-10 border-4 border-blue-500 border-t-transparent rounded-full mb-4">
                    </div>
                    <p class="text-slate-500 text-sm font-medium">Menganalisa komposisi visual...</p>
                </div>
                <div id="motion-content" class="hidden space-y-4">
                    <div class="bg-slate-50 p-5 rounded-xl border border-slate-200 text-slate-700 leading-relaxed">
                        <div class="flex items-center gap-2 mb-3">
                            <span class="bg-blue-100 text-blue-700 text-xs font-bold px-2 py-1 rounded shadow-sm"
                                id="motion-type-tag">PAN RIGHT</span>
                        </div>
                        <p id="motion-desc-text" class="text-sm">...</p>
                    </div>
                    <div>
                        <label class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-2 block">Prompt
                            JSON
                            (Untuk Video AI)</label>
                        <div class="relative">
                            <pre id="motion-json-text"
                                class="bg-slate-900 text-slate-300 p-4 rounded-xl text-xs overflow-x-auto font-mono custom-scrollbar"></pre>
                            <button onclick="copyToClipboard(document.getElementById('motion-json-text').innerText)"
                                class="absolute top-2 right-2 text-[10px] bg-white/10 hover:bg-white/20 text-white px-2 py-1 rounded transition">Copy
                                JSON</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="p-4 bg-slate-50 border-t border-slate-100 text-center">
                <button onclick="closeMotionModal()"
                    class="w-full py-3 bg-white border border-slate-200 text-slate-600 rounded-xl text-sm font-bold shadow-sm hover:bg-slate-100 transition">Tutup</button>
            </div>
        </div>
    </div>

    <!-- NEW: NARRATION MODAL -->
    <div id="narration-modal"
        class="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-[70] hidden p-4">
        <div class="bg-white rounded-2xl w-full max-w-6xl overflow-hidden shadow-2xl animate-fade-in">
            <div class="bg-gradient-to-r from-teal-500 to-green-500 p-6 text-white flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-white/20 rounded-lg flex items-center justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />
                        </svg>
                    </div>
                    <div>
                        <h3 class="font-bold text-lg leading-tight">Narration Script</h3>
                        <p class="text-xs text-white/80">Naskah Iklan & Voiceover</p>
                    </div>
                </div>
                <button onclick="closeNarrationModal()" class="text-white/80 hover:text-white">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <div class="p-6 space-y-6">
                <div id="narration-loading" class="hidden flex flex-col items-center justify-center py-10">
                    <div class="animate-spin w-10 h-10 border-4 border-teal-500 border-t-transparent rounded-full mb-4">
                    </div>
                    <p class="text-slate-500 text-sm font-medium">Copywriter AI sedang menulis naskah...</p>
                </div>
                <div id="narration-content" class="hidden space-y-4">
                    <div>
                        <div class="flex justify-between items-center mb-2">
                            <label class="text-xs font-bold text-slate-400 uppercase tracking-wider">Voiceover
                                Script
                                (Bahasa Indonesia)</label>
                            <button onclick="copyToClipboard(document.getElementById('narration-text').innerText)"
                                class="text-[10px] bg-teal-50 text-teal-600 px-2 py-1 rounded font-bold hover:bg-teal-100 transition">Copy
                                Text</button>
                        </div>
                        <div id="narration-text"
                            class="bg-slate-50 p-4 rounded-xl border border-slate-200 text-xs text-slate-700 leading-relaxed font-medium min-h-[80px]">
                        </div>
                    </div>
                    <div>
                        <div class="flex justify-between items-center mb-2">
                            <label class="text-xs font-bold text-slate-400 uppercase tracking-wider">Tone &
                                Style</label>
                        </div>
                        <div class="flex flex-wrap gap-2" id="narration-tags">
                            <!-- Tags injected here -->
                        </div>
                    </div>
                    <div>
                        <label class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-2 block">Prompt
                            JSON
                            (Untuk Audio AI)</label>
                        <div class="relative">
                            <pre id="narration-json-text"
                                class="bg-slate-900 text-slate-300 p-4 rounded-xl text-xs overflow-x-auto font-mono custom-scrollbar"></pre>
                            <button onclick="copyToClipboard(document.getElementById('narration-json-text').innerText)"
                                class="absolute top-2 right-2 text-[10px] bg-white/10 hover:bg-white/20 text-white px-2 py-1 rounded transition">Copy
                                JSON</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="p-4 bg-slate-50 border-t border-slate-100 text-center">
                <button onclick="closeNarrationModal()"
                    class="w-full py-3 bg-white border border-slate-200 text-slate-600 rounded-xl text-sm font-bold shadow-sm hover:bg-slate-100 transition">Tutup</button>
            </div>
        </div>
    </div>

    <!-- Templates -->
    <template id="upload-template">
        <section class="card rounded-2xl p-6 shadow-sm">
            <div class="flex items-center mb-4">
                <span
                    class="step-badge flex items-center justify-center w-10 h-10 bg-purple-100 text-purple-600 font-bold rounded-full mr-4 text-lg">1</span>
                <h2 class="text-xl font-semibold text-slate-800">Upload Foto <span
                        class="text-sm font-normal text-slate-500 ml-2">(Bisa sampai 5 foto)</span></h2>
            </div>
            <div
                class="upload-area border-2 border-dashed border-slate-300 rounded-2xl p-8 text-center cursor-pointer hover:border-purple-400 transition-all duration-300 bg-slate-50 relative">
                <input type="file" class="hidden file-input" accept="image/jpeg, image/png" multiple>
                <div class="upload-prompt">
                    <svg class="mx-auto h-10 w-10 text-slate-400 mb-3" xmlns="http://www.w3.org/2000/svg" fill="none"
                        viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                            d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                    </svg>
                    <p class="text-slate-600 font-medium text-sm">Klik atau seret foto ke sini</p>
                    <p class="text-slate-400 text-xs mt-1">Maksimal 5 Foto</p>
                </div>

                <div class="preview-container hidden relative mt-2">
                    <img src="" class="preview-img max-h-48 mx-auto rounded-lg shadow-sm border border-slate-200">
                    <button
                        class="remove-btn absolute -top-2 -right-2 bg-red-500 text-white rounded-full p-1 shadow hover:bg-red-600"><svg
                            class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M6 18L18 6M6 6l12 12" />
                        </svg></button>
                </div>
            </div>

            <!-- Thumbnail List -->
            <div id="product-thumbnails" class="mt-4 flex gap-3 overflow-x-auto pb-2 hidden">
            </div>
        </section>
    </template>

    <script>
        // --- CONFIG & STATE ---
        const apiKey = ""; // API Key
        let currentView = 'home';
        let currentEditingImage = null;
        let adImageBase64 = null;
        let adImageMimeType = null;
        let modelImageBase64 = null;
        let modelImageMimeType = null;
        let envImageBase64 = null;
        let envImageMimeType = null;
        let editPoseImageBase64 = null;
        let editPoseMimeType = null;

        let editBgImageBase64 = null;
        let editBgMimeType = null;
        let selectedBgColor = 'transparent';
        let customHexColor = '#14b8a6';

        const styles = [
            {
                id: 'aesthetic',
                name: 'Aesthetic Vibe',
                desc: 'Foto ala kafe kekinian, warm & cozy',
                prompt: `Buatkan foto makanan bergaya *Casual Cafe Aesthetic*. Gunakan latar belakang interior kafe yang estetik namun sedikit blur (bokeh) untuk menciptakan kedalaman. Pencahayaan hangat (warm cozy lighting) yang natural, seolah-olah cahaya matahari sore masuk dari jendela. Gunakan meja kayu tekstur natural atau marmer putih. Suasana santai, lifestyle, dan mengundang selera. Fokus tetap pada makanan yang terlihat lezat dan premium.`,
                iconSvg: `<svg viewBox="0 0 24 24" class="icon-svg" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M18 8h1a4 4 0 0 1 0 8h-1"/><path d="M2 8h16v9a4 4 0 0 1-4 4H6a4 4 0 0 1-4-4V8z"/><line x1="6" y1="1" x2="6" y2="4"/><line x1="10" y1="1" x2="10" y2="4"/><line x1="14" y1="1" x2="14" y2="4"/></svg>`
            },
            {
                id: 'modern-vibe',
                name: 'Modern Vibe',
                desc: 'Suasana cafe modern, terang & clean',
                prompt: `Terapkan gaya *Modern Cafe Lifestyle Photography*. Pertahankan bentuk dan warna makanan asli. Tempatkan makanan di atas meja kafe yang modern (misalnya marmer putih, teraso, atau kayu minimalis terang). Latar belakang adalah interior kafe yang terang, bersih, dan stylish dengan pencahayaan alami yang kuat (bright airy light/daylight). Gunakan bukaan lensa lebar untuk background yang sedikit bokeh namun tetap terasa nuansa ruangannya. Suasana harus terasa chic, kekinian, higienis, dan mengundang selera, seperti foto brunch di kafe hits.`,
                iconSvg: `<svg viewBox="0 0 24 24" class="icon-svg" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M3 21h18"/><path d="M5 21V7a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2v14"/><path d="M9 10a2 2 0 0 0 2 2h2a2 2 0 0 0 2-2"/></svg>`
            },
            {
                id: 'dark',
                name: 'Dark Luxury',
                desc: 'Gelap, elegan & mewah',
                prompt: `Terapkan gaya *Dark & Moody Flatlay Food Photography*. Pertahankan bentuk & warna asli makanan. Gunakan pencahayaan lembut dari satu sisi untuk menonjolkan tekstur dan bayangan dalam. Latar belakang gelap (batu hitam, kain matte, atau kayu tua). Tambahkan properti pendukung. Tone netral hangat, kontras tinggi, dan suasana elegan, premium. Tanpa wajah manusia.`,
                iconSvg: `<svg viewBox="0 0 24 24" class="icon-svg" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>`
            },
            {
                id: 'splash',
                name: 'Splash Action',
                desc: 'Efek tumpahan/levitasi dramatis',
                prompt: `Gunakan gaya *Action Food Photography (Dramatic Levitation)*. Pertahankan bentuk & warna makanan asli. Tambahkan bahan-bahan utama (saus, topping, rempah) yang tampak melayang atau percikan dramatis. PENTING: Warna percikan (splash) harus serasi dan mengambil inspirasi dari warna dominan makanan aslinya. Gunakan pencahayaan sinematik low-key, dengan background gelap. Tingkatkan kontras dan kedalaman untuk hasil profesional dan premium. Tanpa manusia.`,
                iconSvg: `<svg viewBox="0 0 24 24" class="icon-svg" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2.69l5.66 5.66a8 8 0 1 1-11.31 0z"/></svg>`
            },
            {
                id: 'rustic',
                name: 'Rustic Alami',
                desc: 'Nuansa kayu natural & hangat',
                prompt: `Terapkan gaya *Rustic Natural Food Photography*. Gunakan pencahayaan alami lembut dari samping. Gunakan latar meja kayu natural. Tambahkan properti pendukung: linen, sendok kayu, cangkir keramik, bunga kecil. Tone hangat, kontras lembut, saturasi alami. Hasil akhir natural, cozy, dan elegan.`,
                iconSvg: `<svg viewBox="0 0 24 24" class="icon-svg" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M2 22h20"/><path d="M12 2v20"/><path d="M2 12h20"/><path d="M7 2v20"/><path d="M17 2v20"/></svg>`
            },
            {
                id: 'minimal',
                name: 'Bright Clean',
                desc: 'Bersih, terang & minimalis',
                prompt: `Tambahkan gaya foto *Clean Minimalist Food Photography* pada gambar makanan yang diunggah. Gunakan pencahayaan natural lembut dari satu arah (seperti cahaya pagi dari jendela), dengan tone warna terang dan netral %u2014 dominan putih, abu muda, dan beige. Fokuskan pada makanan utama dengan latar belakang yang bersih dan sedikit blur (soft bokeh). Gunakan komposisi sederhana dan rapi, minim properti, hanya tambahkan elemen pendukung alami seperti potongan bahan utama. Pastikan makanan tampak segar, modern, dan higienis.`,
                iconSvg: `<svg viewBox="0 0 24 24" class="icon-svg" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><path d="M12 1v2"/><path d="M12 21v2"/><path d="M4.22 4.22l1.42 1.42"/><path d="M18.36 18.36l1.42 1.42"/><path d="M1 12h2"/><path d="M21 12h2"/><path d="M4.22 19.78l1.42-1.42"/><path d="M18.36 5.64l1.42-1.42"/></svg>`
            },
            {
                id: 'float',
                name: 'Magic Float',
                desc: 'Makanan melayang ajaib',
                prompt: `Buatkan foto makanan bergaya *Floating Action Levitasi*. Pertahankan bentuk dan warna asli makanan. Fokus utama: Makanan (dan elemen pendukungnya seperti remah, serpihan, bumbu) harus tampak melayang di udara. Wadah utama (piring/mangkuk) tetap berada di permukaan meja. Gunakan pencahayaan dramatis dari samping atau atas untuk menonjolkan tekstur. Gunakan latar belakang bertema dapur yang cerah dan bersih. Warna harus vivid, kontras tinggi, dan fokus tajam. Tanpa manusia.`,
                iconSvg: `<svg viewBox="0 0 24 24" class="icon-svg" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M12 19V5"/><polyline points="5 12 12 5 19 12"/></svg>`
            },
            {
                id: 'studio-clean',
                name: 'Katalog Studio',
                desc: 'Foto produk polos untuk menu',
                prompt: `Terapkan gaya *High-End Commercial Studio Photography*. Gunakan latar belakang putih bersih atau abu-abu muda netral (seamless backdrop). Pencahayaan *softbox* merata untuk meminimalkan bayangan keras, tapi tetap menonjolkan dimensi. Fokus sangat tajam (deep depth of field) agar seluruh produk terlihat jelas dan detail. Warna akurat, cerah, dan higienis. Cocok untuk foto menu atau katalog e-commerce profesional.`,
                iconSvg: `<svg viewBox="0 0 24 24" class="icon-svg" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg>`
            },
            {
                id: 'pov-hand',
                name: 'POV Tangan',
                desc: 'Sudut pandang memegang makanan',
                prompt: `Gunakan gaya *First-Person Point of View (POV) Lifestyle*. Tampilkan tangan manusia yang memegang produk makanan tersebut secara natural. Latar belakang harus *out-of-focus* (bokeh) yang sesuai konteks (seperti jalanan kota yang sibuk, suasana kafe yang nyaman, atau taman hijau). Pencahayaan natural (golden hour atau daylight). Memberikan kesan personal, mengajak penonton seolah-olah mereka yang sedang memegang makanan itu.`,
                iconSvg: `<svg viewBox="0 0 24 24" class="icon-svg" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M18 11V6a2 2 0 0 0-2-2v0a2 2 0 0 0-2 2v0"/><path d="M14 10V4a2 2 0 0 0-2-2v0a2 2 0 0 0-2 2v2"/><path d="M10 10.5V6a2 2 0 0 0-2-2v0a2 2 0 0 0-2 2v8"/><path d="M18 8a2 2 0 1 1 4 0v6a8 8 0 0 1-8 8h-2c-2.8 0-4.5-.86-5.99-2.34l-3.6-3.6a2 2 0 0 1 2.83-2.82L7 15"/></svg>`
            },
            {
                id: 'commercial',
                name: 'Pro Dark Ingredients',
                desc: 'Menu Mewah dengan Sebaran Bahan (Dark)',
                prompt: `Terapkan gaya *High-End Dark Gastronomy Photography*. POSISI PRODUK HARUS TEGAK BERDIRI (STANDING UPRIGHT) - JANGAN TIDUR/REBAHAN. Jika produk adalah botol/kemasan, pastikan label menghadap depan dan tegak. Tampilkan makanan utama di tengah. Kelilingi dengan bahan-bahan mentah segar (ingredients) yang RELEVAN dengan produk tersebut. Background gelap bertekstur premium (batu slate/kayu hitam). Pencahayaan dramatis (High Contrast). Hasil tajam, detail, mewah. SATU GAMBAR TUNGGAL, BUKAN KOLASE.`,
                iconSvg: `<svg viewBox="0 0 24 24" class="icon-svg" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/></svg>`
            }
        ];

        const ojolSizes = [
            { id: 'shopee_prof', name: 'Shopee Profil', size: '500x500', ratio: '1:1', platform: 'shopee' },
            { id: 'go_prof', name: 'GoFood Profil', size: '800x800', ratio: '1:1', platform: 'gojek' },
            { id: 'grab_prof', name: 'Grab Profil', size: '1200x800', ratio: '3:2', platform: 'grab' },
            { id: 'shopee_ban', name: 'Shopee Banner', size: '1200x628', ratio: '1.91:1', platform: 'shopee' },
            { id: 'go_ban', name: 'GoFood Banner', size: '1000x750', ratio: '4:3', platform: 'gojek' },
            { id: 'grab_ban', name: 'Grab Banner', size: '1600x400', ratio: '4:1', platform: 'grab' },
            { id: 'youtube_thumb', name: 'YouTube Thumb', size: '1280x720', ratio: '16:9', platform: 'youtube' },
            { id: 'ig_post', name: 'IG Post (Square)', size: '1080x1080', ratio: '1:1', platform: 'instagram' },
            { id: 'ig_portrait', name: 'IG Portrait', size: '1080x1350', ratio: '4:5', platform: 'instagram' },
            { id: 'ig_story', name: 'IG/TikTok Story', size: '1080x1920', ratio: '9:16', platform: 'tiktok' }
        ];

        const productRatios = [
            { id: '1:1', label: 'Square (1:1)', icon: '<rect width="18" height="18" x="3" y="3" rx="2"/>' },
            { id: '16:9', label: 'Landscape (16:9)', icon: '<rect width="18" height="10" x="3" y="7" rx="2"/>' },
            { id: '9:16', label: 'Story (9:16)', icon: '<rect width="10" height="18" x="7" y="3" rx="2"/>' },
            { id: '4:5', label: 'Portrait (4:5)', icon: '<rect width="14" height="18" x="5" y="3" rx="2"/>' }
        ];

        const productState = {
            images: [],
            activeIndex: 0,
            styleId: null,
            ratio: '1:1',
            productName: '',
            logo: { enabled: false, data: null, position: 'top-right', opacity: 0.8 },
            get image() { return this.images[this.activeIndex]?.base64 || null; },
            get mimeType() { return this.images[this.activeIndex]?.mimeType || null; }
        };

        const productModelState = {
            productImages: [],
            modelImage: null,
            modelMime: null,
            activeIndex: 0,
            styleId: null,
            ratio: '1:1',
            productName: '',
            logo: { enabled: false, data: null, position: 'top-right', opacity: 0.8 },
            get currentProductImage() { return this.productImages[this.activeIndex]?.base64 || null; }
        };

        const productMagicState = {
            productImages: [],
            modelImage: null,
            modelMime: null,
            envImage: null,
            envMime: null,
            activeIndex: 0,
            styleId: null,
            ratio: '1:1',
            productName: '',
            logo: { enabled: false, data: null, position: 'top-right', opacity: 0.8 }
        };

        const bannerState = {
            images: [],
            activeIndex: 0,
            styleId: null,
            sizeId: null,
            header: '',
            subHeader: '',
            productName: '',
            logo: { enabled: false, data: null, position: 'top-right', opacity: 0.8 },
            get image() { return this.images[this.activeIndex]?.base64 || null; },
            get mimeType() { return this.images[this.activeIndex]?.mimeType || null; }
        };

        const flowMagicState = {
            productImages: [],
            activeIndex: 0,
            refImage: null,
            refMime: null,
            size: '1:1',
            headline: '',
            subhead: '',
            cta: '',
            footer: '',
            logo: { enabled: false, data: null, position: 'top-right', opacity: 0.8 },
            get currentProductImage() { return this.productImages[this.activeIndex]?.base64 || null; },
            get currentProductMime() { return this.productImages[this.activeIndex]?.mimeType || null; }
        };

        function init() {
            setupNavigation();
            renderProductView();
            renderBannerView();
            renderFlowMagicView();

            document.getElementById('sidebar-toggle').addEventListener('click', toggleSidebar);
            document.getElementById('close-sidebar-mobile').addEventListener('click', toggleSidebar);
            const overlay = document.getElementById('overlay');
            if (overlay) overlay.addEventListener('click', toggleSidebar);


        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('overlay');
            if (window.innerWidth >= 768) {
                sidebar.classList.toggle('collapsed');
                document.getElementById('main-content').classList.toggle('expanded');
            } else {
                sidebar.classList.toggle('open');
                overlay.classList.toggle('active');
            }
        }

        function setupNavigation() {
            switchView('home');
        }

        window.switchView = function (viewId) {
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active-nav', 'bg-white/20'));
            const buttons = document.querySelectorAll('.nav-item');
            buttons.forEach(btn => {
                const onclickVal = btn.getAttribute('onclick');
                if (onclickVal && onclickVal.includes(viewId)) {
                    btn.classList.add('active-nav', 'bg-white/20');
                }
            });

            ['view-home', 'view-product', 'view-banner', 'view-ad-video', 'view-flowmagic', 'view-edit-photo'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.classList.add('hidden');
            });

            const selectedView = document.getElementById(`view-${viewId}`);
            if (selectedView) selectedView.classList.remove('hidden');

            if (viewId === 'flowmagic') {
                renderFlowMagicView();
            } else if (viewId === 'banner') {
                renderBannerView();
            } else if (viewId === 'ad-video') {
                renderAdVideoView();
            }

            if (viewId === 'edit-photo') {
                document.getElementById('edit-intro-placeholder').classList.remove('hidden');
                document.getElementById('edit-mode-pose').classList.add('hidden');
                document.getElementById('edit-mode-bg').classList.add('hidden');

                document.getElementById('tab-pose').classList.remove('active');
                document.getElementById('tab-pose').classList.add('inactive');
                document.getElementById('tab-bg').classList.remove('active');
                document.getElementById('tab-bg').classList.add('inactive');
            }

            const titles = {
                'home': 'Home',
                'product': 'Magic Content',
                'banner': 'Delivery Banner',
                'ad-video': 'Profesional Ads',
                'flowmagic': 'Magic design ‚ú®',
                'edit-photo': 'Magic Editor'
            };
            document.getElementById('page-title').innerText = titles[viewId] || 'Menu';

            currentView = viewId;

            if (window.innerWidth < 768) {
                const sidebar = document.getElementById('sidebar');
                const overlay = document.getElementById('overlay');
                sidebar.classList.remove('open');
                overlay.classList.remove('active');
            }
        };

        window.switchProductMode = function (mode) {
            const onlyContainer = document.getElementById('product-only-container');
            const modelContainer = document.getElementById('product-model-container');
            const magicContainer = document.getElementById('product-magic-container');

            // Re-selecting buttons as they are dynamically rendered
            const tabOnly = document.getElementById('tab-prod-only');
            const tabModel = document.getElementById('tab-prod-model');
            const tabMagic = document.getElementById('tab-prod-magic');

            // Reset all
            if (onlyContainer) onlyContainer.classList.add('hidden');
            if (modelContainer) modelContainer.classList.add('hidden');
            if (magicContainer) magicContainer.classList.add('hidden');

            const btnProd = document.getElementById('btn-gen-product');
            const btnModel = document.getElementById('btn-gen-product-model');
            const btnMagic = document.getElementById('btn-gen-product-magic');

            if (btnProd && btnProd.parentElement) btnProd.parentElement.classList.add('hidden');
            if (btnModel && btnModel.parentElement) btnModel.parentElement.classList.add('hidden');
            if (btnMagic && btnMagic.parentElement) btnMagic.parentElement.classList.add('hidden');

            if (tabOnly) {
                tabOnly.classList.remove('active');
                tabOnly.classList.add('border-slate-200', 'text-slate-500');
            }
            if (tabModel) {
                tabModel.classList.remove('active');
                tabModel.classList.add('border-slate-200', 'text-slate-500');
            }
            if (tabMagic) {
                tabMagic.classList.remove('active');
                tabMagic.classList.add('border-slate-200', 'text-slate-500');
            }

            if (mode === 'only') {
                if (onlyContainer) onlyContainer.classList.remove('hidden');
                if (btnProd && btnProd.parentElement) btnProd.parentElement.classList.remove('hidden');
                if (tabOnly) {
                    tabOnly.classList.add('active');
                    tabOnly.classList.remove('border-slate-200', 'text-slate-500');
                }
            } else if (mode === 'model') {
                if (modelContainer) modelContainer.classList.remove('hidden');
                if (btnModel && btnModel.parentElement) btnModel.parentElement.classList.remove('hidden');
                if (tabModel) {
                    tabModel.classList.add('active');
                    tabModel.classList.remove('border-slate-200', 'text-slate-500');
                }
            } else if (mode === 'magic') {
                if (magicContainer) magicContainer.classList.remove('hidden');
                if (btnMagic && btnMagic.parentElement) btnMagic.parentElement.classList.remove('hidden');
                if (tabMagic) {
                    tabMagic.classList.add('active');
                    tabMagic.classList.remove('border-slate-200', 'text-slate-500');
                }
                initMagicUploadWrapper();
            }

            const resProd = document.getElementById('product-results');
            const resModel = document.getElementById('product-results-model');
            const resMagic = document.getElementById('product-results-magic');

            if (resProd) resProd.classList.add('hidden');
            if (resModel) resModel.classList.add('hidden');
            if (resMagic) resMagic.classList.add('hidden');
        }



        window.handleMagicUpload = function (type, input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                if (type === 'model') {
                    productMagicState.modelImage = e.target.result.split(',')[1];
                    productMagicState.modelMime = file.type;
                    const imgEl = document.getElementById('magic-model-preview');
                    imgEl.src = e.target.result;
                    imgEl.classList.remove('hidden');
                    document.getElementById('magic-model-prompt').classList.add('hidden');
                } else if (type === 'env') {
                    productMagicState.envImage = e.target.result.split(',')[1];
                    productMagicState.envMime = file.type;
                    const imgEl = document.getElementById('magic-env-preview');
                    imgEl.src = e.target.result;
                    imgEl.classList.remove('hidden');
                    document.getElementById('magic-env-prompt').classList.add('hidden');
                }
                checkReady('product-magic');
            };
            reader.readAsDataURL(file);
        }




        window.generateMagicContent = async function () {
            // RELAXED VALIDATION: Only product images are strictly required
            if (productMagicState.productImages.length === 0) {
                return alert("Mohon upload setidaknya satu Foto Produk.");
            }
            // Style is now optional for Magic Content as per user request
            // but if they selected one, we use it. If not, we can default to 'Adaptive'.

            const btn = document.getElementById('btn-gen-product-magic');
            const loading = document.getElementById('product-loading-magic');
            const results = document.getElementById('product-results-magic');

            btn.disabled = true;
            loading.classList.remove('hidden');
            results.classList.add('hidden');
            results.innerHTML = '';

            const style = styles.find(s => s.id === productMagicState.styleId);
            const ratio = productMagicState.ratio || '1:1';

            // DYNAMIC PROMPT CONSTRUCTION
            let promptText = `
                ACT AS A PROFESSIONAL FILM DIRECTOR & COMPOSITE ARTIST.
                TASK: Create a seamless, high-end commercial image featuring the [USER PRODUCT].
            `;

            // Add Concept if present
            if (productMagicState.concept && productMagicState.concept.trim() !== '') {
                promptText += `\n\nCONCEPT / THEME: "${productMagicState.concept}"
                STRICTLY FOLLOW this concept for the mood, lighting, and setting.`;
            }

            // Add Style if selected, otherwise generic high-quality
            if (style) {
                promptText += `\n\nVISUAL STYLE: ${style.name}. ${style.desc}.`;
            } else {
                promptText += `\n\nVISUAL STYLE: Photorealistic, Cinematic, High-End Commercial Photography. clean and aesthetic.`;
            }

            // Instructions based on inputs
            promptText += `\n\nINSTRUCTIONS:`;
            promptText += `\n1. HERO OBJECT: The [USER PRODUCT] must be the clear focal point.`;

            if (productMagicState.modelImage) {
                promptText += `\n2. MODEL INTEGRATION: Seamlessly integrate the product with the [USER MODEL]. Ensure realistic interaction (holding, looking at, or beside). Match lighting perfectly.`;
            } else {
                promptText += `\n2. COMPOSITION: Arrange the product naturally and aesthetically.`;
            }

            if (productMagicState.envImage) {
                promptText += `\n3. ENVIRONMENT: Place the scene within the [USER ENVIRONMENT]. Match the perspective and lighting of the background.`;
            } else {
                promptText += `\n3. BACKGROUND: Generate a background that compliments the Product and Concept.`;
            }

            promptText += `\n4. ASPECT RATIO: ${ratio}.`;
            promptText += `\n5. QUALITY: 8k Resolution, Sharp Focus, Professional Color Grading.`;
            promptText += `\nNO COLLAGE. ONE SINGLE COHESIVE IMAGE.`;

            try {
                const imagesToProcess = [];
                // Add images only if they exist
                if (productMagicState.modelImage) {
                    imagesToProcess.push({ base64: productMagicState.modelImage, mimeType: productMagicState.modelMime });
                }
                if (productMagicState.envImage) {
                    imagesToProcess.push({ base64: productMagicState.envImage, mimeType: productMagicState.envMime });
                }
                // Product images are always added
                productMagicState.productImages.forEach(img => imagesToProcess.push(img));

                const promises = Array(4).fill(null).map(() =>
                    callGeminiAdvancedAPI(promptText, "You are an expert at image compositing.", imagesToProcess, ratio)
                );

                const rawImages = (await Promise.all(promises)).filter(img => img !== null);
                if (rawImages.length === 0) throw new Error("No images generated");

                const finalImages = await Promise.all(rawImages.map(img => applyLogoToResult(img, productMagicState.logo)));

                finalImages.forEach((imgSrc, idx) => {
                    results.innerHTML += createResultCard(imgSrc, idx, ratio);
                });
                results.classList.remove('hidden');

            } catch (err) {
                console.error(err);
                alert("Gagal membuat konten magic. Coba lagi.");
            } finally {
                loading.classList.add('hidden');
                btn.disabled = false;
            }
        }


        window.handleModelUpload = function (input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                productModelState.modelImage = e.target.result.split(',')[1];
                productModelState.modelMime = file.type;
                const imgEl = document.getElementById('model-ref-preview');
                imgEl.src = e.target.result;
                imgEl.classList.remove('hidden');
                document.getElementById('model-ref-prompt').classList.add('hidden');
                checkReady('product-model');
            };
            reader.readAsDataURL(file);
        }

        function initMagicUploadWrapper() {
            const container = document.getElementById('product-magic-container');
            if (!container) return;
            const magicUploadWrapper = container.querySelector('.product-magic-upload-wrapper');
            if (magicUploadWrapper && magicUploadWrapper.children.length === 0) {
                const magicTemplate = document.getElementById('upload-template').content.cloneNode(true);
                magicUploadWrapper.appendChild(magicTemplate);

                const magicFileInput = magicUploadWrapper.querySelector('.file-input');
                const magicUploadArea = magicUploadWrapper.querySelector('.upload-area');
                const magicPreviewContainer = magicUploadWrapper.querySelector('.preview-container');
                const magicPreviewImg = magicUploadWrapper.querySelector('.preview-img');
                const magicRemoveBtn = magicUploadWrapper.querySelector('.remove-btn');
                const magicPromptDiv = magicUploadWrapper.querySelector('.upload-prompt');
                const magicThumbContainer = magicUploadWrapper.querySelector('#product-thumbnails');

                if (magicThumbContainer) magicThumbContainer.id = 'magic-thumbnails-container';

                magicUploadArea.addEventListener('click', () => magicFileInput.click());
                magicFileInput.addEventListener('change', (e) => handleBatchUpload(e, productMagicState, magicPreviewImg, magicPreviewContainer, magicPromptDiv, magicThumbContainer, 'product-magic'));
                magicRemoveBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    resetUpload(productMagicState, magicFileInput, magicPreviewContainer, magicPromptDiv, 'product-magic', magicThumbContainer);
                });
            }
        }


        window.generateProductModelPhotos = async function () {
            if (productModelState.productImages.length === 0 || !productModelState.modelImage) {
                return alert("Mohon upload Foto Produk DAN Foto Model terlebih dahulu.");
            }
            if (!productModelState.styleId) return alert("Pilih Tema terlebih dahulu.");

            const btn = document.getElementById('btn-gen-product-model');
            const loading = document.getElementById('product-loading-model');
            const results = document.getElementById('product-results-model');

            btn.disabled = true;
            loading.classList.remove('hidden');
            results.classList.add('hidden');
            results.innerHTML = '';

            const style = styles.find(s => s.id === productModelState.styleId);
            const ratio = productModelState.ratio || '1:1';

            const promptText = `
                ACT AS A PROFESSIONAL FASHION & PRODUCT PHOTOGRAPHER. 
                TASK: Combine the [USER PRODUCT] and the [USER MODEL] into a single high-end lifestyle shot.
                STYLE: ${style.name}. ${style.desc}.
                INSTRUCTIONS:
                1. Place the product realistically in the hands of the model or next to the model.
                2. Match the lighting of the product to the lighting of the model image.
                3. The background should follow the style: ${style.prompt}.
                4. Aspect ratio: ${ratio}.
                5. High resolution, photorealistic, 8k.
                NO COLLAGE. ONE SINGLE SEAMLESS IMAGE.
            `;

            try {
                const imagesToProcess = [];
                imagesToProcess.push({ base64: productModelState.modelImage, mimeType: productModelState.modelMime });
                productModelState.productImages.forEach(img => imagesToProcess.push(img));

                const promises = Array(4).fill(null).map(() =>
                    callGeminiAdvancedAPI(promptText, "You are a professional cinematographer and composite artist.", imagesToProcess, ratio)
                );

                const rawImages = (await Promise.all(promises)).filter(img => img !== null);
                if (rawImages.length === 0) throw new Error("No images generated");

                const finalImages = await Promise.all(rawImages.map(img => applyLogoToResult(img, productModelState.logo)));

                finalImages.forEach((imgSrc, idx) => {
                    results.innerHTML += createResultCard(imgSrc, idx, ratio);
                });
                results.classList.remove('hidden');
            } catch (err) {
                console.error(err);
                alert("Gagal membuat gambar. Coba lagi.");
            } finally {
                loading.classList.add('hidden');
                btn.disabled = false;
            }
        }

        function renderProductView() {
            const container = document.getElementById('product-logic-container');
            container.innerHTML = `
                <div class="flex gap-2 mb-6 max-w-2xl mx-auto">
                    <button onclick="switchProductMode('only')" id="tab-prod-only" class="tab-btn active px-4 py-3 rounded-xl border font-bold text-sm flex-1 transition-all">Hanya Produk</button>
                    <button onclick="switchProductMode('model')" id="tab-prod-model" class="tab-btn px-4 py-3 rounded-xl border border-slate-200 text-slate-500 font-bold text-sm flex-1 transition-all">Produk & Model</button>
                    <button onclick="switchProductMode('magic')" id="tab-prod-magic" class="tab-btn px-4 py-3 rounded-xl border border-slate-200 text-slate-500 font-bold text-sm flex-1 transition-all">Magic Content</button>
                </div>

                <div id="product-only-container" class="space-y-6">
                    <div class="product-upload-wrapper"></div>
                    <section id="product-detail-section" class="card rounded-2xl p-6 shadow-sm mb-4 hidden">
                        <h3 class="font-semibold mb-4 text-slate-800">Detail Produk</h3>
                        <div>
                            <label class="block text-xs font-medium text-slate-500 mb-1">Nama/Jenis Makanan (Penting agar bahan sesuai)</label>
                            <input type="text" id="product-name-input" placeholder="Cth: Kopi Gula Aren, Nasi Goreng..." class="w-full p-3 rounded-xl border border-slate-300 bg-slate-50 focus:ring-2 focus:ring-purple-500 outline-none text-slate-700">
                        </div>
                    </section>
                </div>

                <div id="product-model-container" class="space-y-6 hidden">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="product-model-upload-wrapper"></div>
                        <div class="card rounded-2xl p-6 shadow-sm border-l-4 border-pink-500">
                             <div class="flex items-center mb-3">
                                <span class="step-badge flex items-center justify-center w-8 h-8 bg-pink-100 text-pink-600 font-bold rounded-full mr-3 text-sm">2</span>
                                <label class="text-sm font-bold text-slate-700">Foto Model / Talent (Wajib)</label>
                            </div>
                            <div class="border-2 border-dashed border-slate-300 rounded-xl p-4 text-center cursor-pointer hover:border-pink-400 bg-slate-50 relative" onclick="document.getElementById('model-ref-input').click()">
                                <input type="file" id="model-ref-input" class="hidden" accept="image/*" onchange="handleModelUpload(this)">
                                <div id="model-ref-prompt">
                                    <svg class="mx-auto h-8 w-8 text-pink-400 mb-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>
                                    <p class="text-xs text-slate-600 font-medium">Upload Foto Model</p>
                                </div>
                                <img id="model-ref-preview" src="" class="hidden max-h-40 mx-auto rounded shadow-sm object-contain">
                            </div>
                        </div>
                    </div>
                </div>


                <div id="product-magic-container" class="space-y-6 hidden">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="product-magic-upload-wrapper col-span-1"></div>
                        
                        <div class="card rounded-2xl p-6 shadow-sm border-l-4 border-pink-500 col-span-1">
                             <div class="flex items-center mb-3">
                                <span class="step-badge flex items-center justify-center w-8 h-8 bg-pink-100 text-pink-600 font-bold rounded-full mr-3 text-sm">2</span>
                                <label class="text-sm font-bold text-slate-700">Foto Model (Opsional)</label>
                            </div>
                            <div class="border-2 border-dashed border-slate-300 rounded-xl p-4 text-center cursor-pointer hover:border-pink-400 bg-slate-50 relative" onclick="document.getElementById('magic-model-input').click()">
                                <input type="file" id="magic-model-input" class="hidden" accept="image/*" onchange="handleMagicUpload('model', this)">
                                <div id="magic-model-prompt">
                                    <svg class="mx-auto h-8 w-8 text-pink-400 mb-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>
                                    <p class="text-xs text-slate-600 font-medium">Upload Model</p>
                                </div>
                                <img id="magic-model-preview" src="" class="hidden max-h-40 mx-auto rounded shadow-sm object-contain">
                            </div>
                        </div>

                         <div class="card rounded-2xl p-6 shadow-sm border-l-4 border-teal-500 col-span-1">
                             <div class="flex items-center mb-3">
                                <span class="step-badge flex items-center justify-center w-8 h-8 bg-teal-100 text-teal-600 font-bold rounded-full mr-3 text-sm">3</span>
                                <label class="text-sm font-bold text-slate-700">Foto Lingkungan (Opsional)</label>
                            </div>
                            <div class="border-2 border-dashed border-slate-300 rounded-xl p-4 text-center cursor-pointer hover:border-teal-400 bg-slate-50 relative" onclick="document.getElementById('magic-env-input').click()">
                                <input type="file" id="magic-env-input" class="hidden" accept="image/*" onchange="handleMagicUpload('env', this)">
                                <div id="magic-env-prompt">
                                    <svg class="mx-auto h-8 w-8 text-teal-400 mb-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2 2 2 0 012 2v2.945M8 3.935V5.5A2.5 2.5 0 0010.5 8h.5a2 2 0 012 2 2 2 0 104 0 2 2 0 012-2h1.064M15 20.488V18a2 2 0 012-2h3.064M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                                    <p class="text-xs text-slate-600 font-medium">Upload Lokasi/Background</p>
                                </div>
                                <img id="magic-env-preview" src="" class="hidden max-h-40 mx-auto rounded shadow-sm object-contain">
                            </div>
                        </div>
                    </div>
                    
                    <div class="card rounded-2xl p-6 shadow-sm mb-4">
                        <h3 class="font-semibold mb-4 text-slate-800">Konsep Konten (Opsional)</h3>
                        <div>
                            <textarea id="magic-concept-input" rows="3" placeholder="Jelaskan konsep yang diinginkan (cth: Musim panas yang cerah, elegan dan mewah, suasana santai di cafe...)" class="w-full p-3 rounded-xl border border-slate-300 bg-slate-50 focus:ring-2 focus:ring-purple-500 outline-none text-slate-700" oninput="productMagicState.concept = this.value"></textarea>
                        </div>
                    </div>
                </div>

                <section class="card rounded-2xl p-6 shadow-sm">
                    <h3 class="font-semibold mb-4 text-slate-800">Pilih Tema</h3>
                    <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-4" id="product-style-grid">
                        ${styles.map(s => `
                            <div onclick="selectStyle('product', '${s.id}')" id="product-style-${s.id}" class="selection-card rounded-xl p-3 cursor-pointer text-center hover:bg-purple-50 flex flex-col items-center justify-center gap-2 has-tooltip">
                                <div class="absolute top-2 right-2 text-slate-400 hover:text-purple-600 info-icon">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                                </div>
                                <div class="tooltip">${s.desc}</div>
                                <div class="text-slate-400">${s.iconSvg}</div>
                                <div class="text-xs font-medium text-slate-600 text-center leading-tight">${s.name}</div>
                            </div>
                        `).join('')}
                    </div>
                </section>

                <section class="card rounded-2xl p-6 shadow-sm">
                    <h3 class="font-semibold mb-4 text-slate-800">Pilih Ukuran</h3>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4" id="product-ratio-grid">
                        ${productRatios.map((r, index) => `
                            <div onclick="selectProductRatio('${r.id}')" id="ratio-${r.id.replace(':', '-')}" class="selection-card rounded-xl p-3 cursor-pointer text-center hover:bg-purple-50 flex flex-col items-center justify-center gap-2 ${r.id === '1:1' ? 'selected' : ''}">
                                <div class="text-slate-400"><svg viewBox="0 0 24 24" class="icon-svg" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">${r.icon}</svg></div>
                                <div class="text-xs font-medium text-slate-600">${r.label}</div>
                            </div>
                        `).join('')}
                    </div>
                </section>

                ${getLogoHTML('product')}

                <div id="product-only-btn-wrapper">
                    <button onclick="generateProductPhotos()" id="btn-gen-product" class="w-full py-4 rounded-xl font-bold text-white shadow-lg bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 transition transform hover:scale-[1.02] disabled:opacity-50 disabled:scale-100" disabled>Buat 4 Foto Produk</button>
                    <div id="product-loading" class="hidden text-center py-8">
                        <div class="animate-spin w-10 h-10 border-4 border-purple-500 border-t-transparent rounded-full mx-auto"></div>
                        <p class="mt-4 text-slate-500">Sedang memproses...</p>
                    </div>
                    <div id="product-results" class="grid grid-cols-2 gap-4 mt-6 hidden"></div>
                </div>

                <div id="product-model-btn-wrapper" class="hidden">
                    <button onclick="generateProductModelPhotos()" id="btn-gen-product-model" class="w-full py-4 rounded-xl font-bold text-white shadow-lg bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-purple-700 hover:to-indigo-700 transition transform hover:scale-[1.02] disabled:opacity-50 disabled:scale-100" disabled>Generate Produk & Model</button>
                    <div id="product-loading-model" class="hidden text-center py-8">
                        <div class="animate-spin w-10 h-10 border-4 border-indigo-500 border-t-transparent rounded-full mx-auto"></div>
                        <p class="mt-4 text-slate-500">Menyatukan Produk & Model...</p>
                    </div>
                    <div id="product-results-model" class="grid grid-cols-2 gap-4 mt-6 hidden"></div>
                </div>

                <div id="product-magic-btn-wrapper" class="hidden">
                    <button onclick="generateMagicContent()" id="btn-gen-product-magic" class="w-full py-4 rounded-xl font-bold text-white shadow-lg bg-gradient-to-r from-pink-500 to-rose-500 hover:from-pink-600 hover:to-rose-600 transition transform hover:scale-[1.02] disabled:opacity-50 disabled:scale-100" disabled>‚ú® Generate Magic Content</button>
                    <div id="product-loading-magic" class="hidden text-center py-8">
                        <div class="animate-spin w-10 h-10 border-4 border-pink-500 border-t-transparent rounded-full mx-auto"></div>
                        <p class="mt-4 text-slate-500">Sedang melakukan sulap...</p>
                    </div>
                    <div id="product-results-magic" class="grid grid-cols-2 gap-4 mt-6 hidden"></div>
                </div>
            `;

            const onlyWrapper = container.querySelector('.product-upload-wrapper');
            const onlyTemplate = document.getElementById('upload-template').content.cloneNode(true);
            onlyWrapper.appendChild(onlyTemplate);

            const fileInputOnly = onlyWrapper.querySelector('.file-input');
            const uploadAreaOnly = onlyWrapper.querySelector('.upload-area');
            const previewContainerOnly = onlyWrapper.querySelector('.preview-container');
            const previewImgOnly = onlyWrapper.querySelector('.preview-img');
            const promptDivOnly = onlyWrapper.querySelector('.upload-prompt');
            const thumbContainerOnly = onlyWrapper.querySelector('#product-thumbnails');

            uploadAreaOnly.addEventListener('click', () => fileInputOnly.click());
            fileInputOnly.addEventListener('change', (e) => handleBatchUpload(e, productState, previewImgOnly, previewContainerOnly, promptDivOnly, thumbContainerOnly, 'product'));

            const modelWrapper = container.querySelector('.product-model-upload-wrapper');
            const modelTemplate = document.getElementById('upload-template').content.cloneNode(true);
            modelWrapper.appendChild(modelTemplate);

            const fileInputModel = modelWrapper.querySelector('.file-input');
            const uploadAreaModel = modelWrapper.querySelector('.upload-area');
            const previewContainerModel = modelWrapper.querySelector('.preview-container');
            const previewImgModel = modelWrapper.querySelector('.preview-img');
            const promptDivModel = modelWrapper.querySelector('.upload-prompt');
            const thumbContainerModel = modelWrapper.querySelector('#product-thumbnails');

            uploadAreaModel.addEventListener('click', () => fileInputModel.click());
            fileInputModel.addEventListener('change', (e) => handleBatchUpload(e, productModelState, previewImgModel, previewContainerModel, promptDivModel, thumbContainerModel, 'product-model'));

            document.getElementById('product-name-input').addEventListener('input', (e) => {
                productState.productName = e.target.value;
                productModelState.productName = e.target.value;
            });
        }

        window.handleBatchUpload = function (e, stateObj, imgEl, containerEl, promptEl, thumbContainerEl, type) {
            const files = Array.from(e.target.files).slice(0, 5);
            if (files.length === 0) return;

            if (type === 'flowmagic') stateObj.productImages = [];
            else if (type === 'product-model') stateObj.productImages = [];
            else if (type === 'product-magic') stateObj.productImages = []; // Add support for magic
            else stateObj.images = [];

            stateObj.activeIndex = 0;
            thumbContainerEl.innerHTML = '';
            thumbContainerEl.classList.remove('hidden');

            files.forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = (ev) => {
                    const imgObj = { base64: ev.target.result.split(',')[1], mimeType: file.type, src: ev.target.result };

                    if (type === 'flowmagic' || type === 'product-model' || type === 'product-magic') stateObj.productImages.push(imgObj);
                    else stateObj.images.push(imgObj);

                    const thumb = document.createElement('img');
                    thumb.src = ev.target.result;
                    thumb.className = `w-16 h-16 rounded-lg object-cover cursor-pointer border-2 transition-all ${index === 0 ? 'thumb-selected' : 'thumb-inactive'}`;
                    thumb.onclick = () => selectActiveImage(index, stateObj, imgEl, thumbContainerEl, type);
                    thumbContainerEl.appendChild(thumb);

                    if (index === 0) {
                        imgEl.src = ev.target.result;
                        containerEl.classList.remove('hidden');
                        promptEl.classList.add('hidden');
                    }
                    checkReady(type);
                };
                reader.readAsDataURL(file);
            });
        }


        function checkReady(type) {
            if (type === 'product') {
                const btn = document.getElementById('btn-gen-product');
                if (btn) btn.disabled = !(productState.images.length > 0 && productState.styleId);
            } else if (type === 'product-model') {
                const btn = document.getElementById('btn-gen-product-model');
                if (btn) btn.disabled = !(productModelState.productImages.length > 0 && productModelState.modelImage && productModelState.styleId);
            } else if (type === 'banner') {
                const btn = document.getElementById('btn-gen-banner');
                if (btn) btn.disabled = !(bannerState.images.length > 0 && bannerState.styleId && bannerState.sizeId);
            } else if (type === 'product-magic') {
                const btn = document.getElementById('btn-gen-product-magic');
                // Relaxed: Only product images are strictly required. Style/Model/Env are optional.
                if (btn) btn.disabled = !(productMagicState.productImages.length > 0);
            }
        }

        window.selectStyle = function (type, styleId) {
            if (type === 'banner') {
                bannerState.styleId = styleId;
                document.querySelectorAll(`#banner-style-grid .selection-card`).forEach(el => el.classList.remove('selected'));
                const targetBanner = document.getElementById(`banner-style-${styleId}`);
                if (targetBanner) targetBanner.classList.add('selected');

                const bannerDetailWrapper = document.getElementById('banner-product-name-wrapper');
                if (bannerDetailWrapper) {
                    styleId === 'commercial' ? bannerDetailWrapper.classList.remove('hidden') : bannerDetailWrapper.classList.add('hidden');
                }

                checkReady('banner');
                return;
            }

            productState.styleId = styleId;
            productModelState.styleId = styleId;
            productMagicState.styleId = styleId;

            document.querySelectorAll(`#product-style-grid .selection-card`).forEach(el => el.classList.remove('selected'));
            const targetProd = document.getElementById(`product-style-${styleId}`);
            if (targetProd) targetProd.classList.add('selected');

            const detailSection = document.getElementById('product-detail-section');
            if (detailSection) {
                styleId === 'commercial' ? detailSection.classList.remove('hidden') : detailSection.classList.add('hidden');
            }

            checkReady('product');
            checkReady('product-model');
            checkReady('product-magic');
        };

        window.selectProductRatio = function (ratioId) {
            productState.ratio = ratioId;
            productModelState.ratio = ratioId;
            productMagicState.ratio = ratioId;
            document.querySelectorAll('#product-ratio-grid .selection-card').forEach(el => el.classList.remove('selected'));
            document.getElementById(`ratio-${ratioId.replace(':', '-')}`).classList.add('selected');
        };

        function getLogoHTML(type) { return `<section class="card rounded-2xl p-6 shadow-sm"><div class="flex items-center justify-between mb-4"><div class="flex items-center"><h3 class="font-semibold text-slate-800">Upload Logo <span class="text-sm font-normal text-slate-400">(Opsional)</span></h3></div><label class="inline-flex relative items-center cursor-pointer"><input type="checkbox" id="logo-toggle-${type}" class="sr-only peer" onchange="toggleLogoSection('${type}', this.checked)"><div class="w-11 h-6 bg-slate-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-slate-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-purple-500"></div></label></div><div id="logo-options-${type}" class="hidden space-y-6 pt-4 border-t border-slate-100"><div class="border-2 border-dashed border-slate-300 rounded-xl p-6 text-center cursor-pointer hover:border-purple-400 transition-all duration-300 bg-slate-50" id="logo-area-${type}" onclick="document.getElementById('logo-input-${type}').click()"><input type="file" id="logo-input-${type}" class="hidden" accept="image/png" onchange="handleLogoUpload('${type}', this)"><div id="logo-prompt-${type}"><p class="text-sm text-slate-600">Klik untuk upload logo (PNG Transparan)</p></div><div id="logo-preview-container-${type}" class="hidden relative w-24 h-24 mx-auto"><img id="logo-preview-${type}" src="" class="max-w-full max-h-full object-contain mx-auto"><button onclick="event.stopPropagation(); resetLogo('${type}')" class="absolute -top-2 -right-2 bg-white rounded-full p-1 shadow hover:text-red-500"><svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg></button></div></div><div class="grid grid-cols-2 gap-4"><div><label class="block text-xs font-medium text-slate-500 mb-1">Posisi</label><select onchange="updateLogoState('${type}', 'position', this.value)" class="w-full text-sm border-slate-200 rounded-lg p-2.5 bg-slate-50"><option value="top-right">Kanan Atas</option><option value="top-left">Kiri Atas</option><option value="bottom-right">Kanan Bawah</option><option value="bottom-left">Kiri Bawah</option><option value="center">Tengah</option></select></div><div><label class="block text-xs font-medium text-slate-500 mb-1">Transparansi</label><input type="range" min="0.1" max="1" step="0.1" value="0.8" oninput="updateLogoState('${type}', 'opacity', this.value)" class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-purple-500"></div></div></div></section>`; }
        function renderBannerView() { const container = document.getElementById('banner-logic-container'); container.innerHTML = `<div class="banner-upload-wrapper"></div><div class="grid grid-cols-1 md:grid-cols-2 gap-6"><section class="card rounded-2xl p-6 shadow-sm"><h3 class="font-semibold mb-4 text-slate-800">Detail & Teks</h3><div class="space-y-4"><div id="banner-product-name-wrapper" class="hidden"><label class="block text-xs font-medium text-slate-500 mb-1">Nama/Jenis Makanan (Penting!)</label><input type="text" id="banner-product-name" placeholder="Cth: Es Kopi Susu, Ayam Geprek..." class="w-full p-3 rounded-xl border border-slate-300 bg-slate-50 focus:ring-2 focus:ring-purple-500 outline-none text-slate-700"></div><div class="border-t border-slate-100 pt-3"><label class="block text-xs font-medium text-slate-500 mb-1">Header (Opsional - Overlay)</label><input type="text" id="banner-header-input" placeholder="Kosongkan jika ingin polos" class="w-full p-3 rounded-xl border border-slate-300 bg-slate-50 focus:ring-2 focus:ring-purple-500 outline-none text-slate-700 font-bold"></div><div><label class="block text-xs font-medium text-slate-500 mb-1">Sub-Header (Opsional - Overlay)</label><input type="text" id="banner-subheader-input" placeholder="Keterangan tambahan..." class="w-full p-3 rounded-xl border border-slate-300 bg-slate-50 focus:ring-2 focus:ring-purple-500 outline-none text-slate-700"></div></div></section><section class="card rounded-2xl p-6 shadow-sm"><h3 class="font-semibold mb-4 text-slate-800">Pilih Tema</h3><div class="grid grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-3" id="banner-style-grid">${styles.map(s => `<div onclick="selectStyle('banner', '${s.id}')" id="banner-style-${s.id}" class="selection-card rounded-xl p-2 cursor-pointer text-center flex flex-col items-center justify-center gap-1 has-tooltip"><div class="absolute top-1 right-1 text-slate-400 hover:text-purple-600 info-icon"><svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg></div><div class="tooltip">${s.desc}</div><div class="text-slate-400" style="transform: scale(0.7);">${s.iconSvg}</div><div class="text-[10px] font-medium mt-1 text-slate-600 truncate w-full">${s.name}</div></div>`).join('')}</div></section></div>${getLogoHTML('banner')}<section class="card rounded-2xl p-6 shadow-sm"><h3 class="font-semibold mb-4 text-slate-800">Pilih Platform & Ukuran</h3><div class="grid grid-cols-2 md:grid-cols-3 gap-4" id="banner-size-grid">${ojolSizes.map(size => `<div onclick="selectBannerSize('${size.id}')" id="size-${size.id}" class="selection-card rounded-xl p-4 cursor-pointer relative overflow-hidden group"><div class="absolute top-0 right-0 w-16 h-16 bg-${getPlatformColor(size.platform)}/10 rounded-bl-full -mr-8 -mt-8"></div><h4 class="font-bold text-sm text-slate-700">${size.name}</h4><p class="text-xs text-slate-500">${size.size}</p><div class="text-[10px] mt-2 px-2 py-1 rounded bg-slate-100 inline-block">${size.ratio}</div></div>`).join('')}</div></section><button onclick="generateBannerPhotos()" id="btn-gen-banner" class="w-full py-4 rounded-xl font-bold text-white shadow-lg bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 transition transform hover:scale-[1.02] disabled:opacity-50 disabled:scale-100" disabled>Buat 4 Foto Banner</button><div id="banner-loading" class="hidden text-center py-8"><div class="animate-spin w-10 h-10 border-4 border-purple-500 border-t-transparent rounded-full mx-auto"></div><p class="mt-4 text-slate-500">Sedang memproses...</p></div><div id="banner-results" class="grid grid-cols-1 md:grid-cols-2 gap-6 hidden"></div>`; const uploadWrapper = container.querySelector('.banner-upload-wrapper'); const template = document.getElementById('upload-template').content.cloneNode(true); uploadWrapper.appendChild(template); const fileInput = uploadWrapper.querySelector('.file-input'); const uploadArea = uploadWrapper.querySelector('.upload-area'); const previewContainer = uploadWrapper.querySelector('.preview-container'); const previewImg = uploadWrapper.querySelector('.preview-img'); const removeBtn = uploadWrapper.querySelector('.remove-btn'); const promptDiv = uploadWrapper.querySelector('.upload-prompt'); const thumbContainer = uploadWrapper.querySelector('#product-thumbnails'); thumbContainer.id = 'banner-thumbnails-container'; uploadArea.addEventListener('click', () => fileInput.click()); fileInput.addEventListener('change', (e) => handleBatchUpload(e, bannerState, previewImg, previewContainer, promptDiv, thumbContainer, 'banner')); removeBtn.addEventListener('click', (e) => { e.stopPropagation(); resetUpload(bannerState, fileInput, previewContainer, promptDiv, 'banner', thumbContainer); }); document.getElementById('banner-header-input').addEventListener('input', (e) => { bannerState.header = e.target.value; }); document.getElementById('banner-subheader-input').addEventListener('input', (e) => { bannerState.subHeader = e.target.value; }); document.getElementById('banner-product-name').addEventListener('input', (e) => { bannerState.productName = e.target.value; }); }
        function renderFlowMagicView() {
            const container = document.getElementById('flowmagic-logic-container');
            container.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div class="space-y-6">
                        <div class="card rounded-2xl p-6 shadow-sm border-l-4 border-purple-500 flow-product-upload-wrapper">
                            <div class="flex items-center mb-3">
                                <span class="step-badge flex items-center justify-center w-8 h-8 bg-purple-100 text-purple-600 font-bold rounded-full mr-3 text-sm">1</span>
                                <label class="text-sm font-bold text-slate-700">Foto Produk (Bisa Banyak)</label>
                            </div>
                        </div>
                        <div class="card rounded-2xl p-6 shadow-sm border-l-4 border-pink-500">
                            <div class="flex items-center mb-3">
                                <span class="step-badge flex items-center justify-center w-8 h-8 bg-pink-100 text-pink-600 font-bold rounded-full mr-3 text-sm">2</span>
                                <label class="text-sm font-bold text-slate-700">Referensi Desain (Wajib)</label>
                            </div>
                            <div class="border-2 border-dashed border-slate-300 rounded-xl p-4 text-center cursor-pointer hover:border-pink-400 bg-slate-50 relative" onclick="document.getElementById('flow-ref-input').click()">
                                <input type="file" id="flow-ref-input" class="hidden" accept="image/*" onchange="handleFlowRefUpload(this)">
                                <div id="flow-ref-prompt">
                                    <svg class="mx-auto h-8 w-8 text-pink-400 mb-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                                    <p class="text-xs text-slate-600 font-medium">Upload Contoh Desain / Poster</p>
                                </div>
                                <img id="flow-ref-preview" src="" class="hidden max-h-40 mx-auto rounded shadow-sm object-contain">
                            </div>
                        </div>

                        <!-- NEW: Text Replacement UI in Input Column -->
                        <div id="flow-text-replacement-container" class="hidden card rounded-2xl p-6 shadow-sm border-l-4 border-blue-500">
                             <div class="flex items-center mb-3">
                                <span class="step-badge flex items-center justify-center w-8 h-8 bg-blue-100 text-blue-600 font-bold rounded-full mr-3 text-sm">3</span>
                                <label class="text-sm font-bold text-slate-700">Edit Teks Terdeteksi</label>
                            </div>
                            <p class="text-xs text-slate-500 mb-3">AI otomatis membaca teks dari referensi. Edit di sini sebelum generate.</p>
                            <div class="bg-slate-50 p-3 rounded-xl border border-slate-200 space-y-3 max-h-60 overflow-y-auto" id="flow-detected-texts-list">
                                <!-- Dynamic inputs will be injected here -->
                            </div>
                        </div>

                        <div class="card rounded-2xl p-6 shadow-sm space-y-4">
                            <h3 class="font-semibold text-slate-800">4. Pengaturan</h3>
                            <div>
                                <label class="block text-xs font-medium text-slate-500 mb-1">Ukuran Desain</label>
                                <select id="flow-size" class="w-full p-2.5 rounded-xl border border-slate-300 bg-slate-50 text-sm" onchange="flowMagicState.size = this.value">
                                    <option value="1:1">Square (1:1) - Instagram Feed</option>
                                    <option value="4:5">Portrait (4:5) - IG Ads</option>
                                    <option value="9:16">Story (9:16) - TikTok/Reels</option>
                                    <option value="3:4">Poster (3:4)</option>
                                </select>
                            </div>
                        </div>
                        ${getLogoHTML('flowmagic')}
                        <button onclick="generateFlowMagic()" id="btn-gen-flow" class="w-full py-4 rounded-xl font-bold text-white shadow-lg bg-gradient-to-r from-yellow-400 via-pink-500 to-purple-600 hover:scale-[1.02] transition transform disabled:opacity-50 disabled:scale-100 flex items-center justify-center gap-2">
                            <span>‚ú® Generate Magic Design</span>
                        </button>
                    </div>
                    
                    <div class="flex flex-col h-full">
                        <div id="flow-loading" class="hidden flex-1 flex flex-col items-center justify-center p-12 bg-white rounded-2xl shadow-sm border border-slate-100 min-h-[400px]">
                            <div class="loading-shimmer w-full h-full absolute inset-0 opacity-20"></div>
                            <div class="animate-spin w-16 h-16 border-4 border-pink-500 border-t-transparent rounded-full mb-6 relative z-10"></div>
                            <h3 class="text-xl font-bold text-slate-800 relative z-10">AI Professional Designer Sedang Bekerja...</h3>
                            <p class="text-sm text-slate-500 mt-2 text-center max-w-xs relative z-10">Menganalisa layer, font, dan elemen 3D dari referensi, lalu merekreasinya untuk brand Anda.</p>
                        </div>
                        
                        <div id="flow-result-container" class="hidden flex-col gap-4">
                            <div class="bg-white p-4 rounded-2xl shadow-lg border border-purple-100">
                                <h3 class="font-bold text-slate-800 mb-4 flex items-center gap-2"><span class="text-xl">üé®</span> Hasil Desain Final</h3>
                                <div id="flow-image-wrapper" class="relative group rounded-xl overflow-hidden shadow-sm bg-slate-100 min-h-[300px] flex items-center justify-center">
                                    <img id="flow-final-image" src="" class="max-w-full max-h-[600px] object-contain shadow-md">
                                    <div class="absolute inset-0 bg-black/60 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center gap-4">
                                        <button onclick="downloadFlowImage()" class="bg-white text-slate-800 px-4 py-2 rounded-full font-bold text-sm shadow hover:bg-slate-100 flex items-center gap-2">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>Download
                                        </button>
                                        <button onclick="openEditModalForFlow()" class="bg-purple-600 text-white px-4 py-2 rounded-full font-bold text-sm shadow hover:bg-purple-700 flex items-center gap-2">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" /></svg>Manual Edit
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div id="flow-placeholder" class="flex-1 flex flex-col items-center justify-center p-8 bg-slate-50 rounded-2xl border-2 border-dashed border-slate-200 min-h-[400px]">
                            <span class="text-4xl mb-4">ü™Ñ</span>
                            <h3 class="font-bold text-slate-400">Hasil Desain Akan Muncul Disini</h3>
                            <p class="text-sm text-slate-400 mt-2 text-center">Upload produk Anda (boleh >1) & referensi desain di sebelah kiri.</p>
                        </div>
                    </div>
                </div>`;

            const uploadWrapper = container.querySelector('.flow-product-upload-wrapper');
            const template = document.getElementById('upload-template').content.cloneNode(true);
            uploadWrapper.appendChild(template);

            const fileInput = uploadWrapper.querySelector('.file-input');
            const uploadArea = uploadWrapper.querySelector('.upload-area');
            const previewContainer = uploadWrapper.querySelector('.preview-container');
            const previewImg = uploadWrapper.querySelector('.preview-img');
            const removeBtn = uploadWrapper.querySelector('.remove-btn');
            const promptDiv = uploadWrapper.querySelector('.upload-prompt');
            const thumbContainer = uploadWrapper.querySelector('#product-thumbnails');

            thumbContainer.id = 'flow-thumbnails-container';

            uploadArea.addEventListener('click', () => fileInput.click());
            fileInput.addEventListener('change', (e) => handleBatchUpload(e, flowMagicState, previewImg, previewContainer, promptDiv, thumbContainer, 'flowmagic'));
            removeBtn.addEventListener('click', (e) => { e.stopPropagation(); resetUpload(flowMagicState, fileInput, previewContainer, promptDiv, 'flowmagic', thumbContainer); });
        }


        window.openEditModalForFlow = function () {
            const imgEl = document.getElementById('flow-final-image');
            if (!imgEl || !imgEl.src) return alert("Belum ada gambar untuk diedit.");
            openEditModal(imgEl.src);
        }


        window.toggleModalFullScreen = function () {
            const modalContent = document.getElementById('edit-modal-content');
            const iconMax = document.getElementById('icon-maximize');
            const iconMin = document.getElementById('icon-minimize');
            const isMaximized = modalContent.classList.contains('fixed') && modalContent.classList.contains('inset-0');
            if (isMaximized) {
                modalContent.classList.remove('fixed', 'inset-0', 'z-[60]', 'rounded-none', 'm-0');
                modalContent.classList.add('md:rounded-2xl', 'max-w-4xl', 'md:h-[90vh]', 'h-full');
                modalContent.style.width = '';
                modalContent.style.height = '';
                iconMax.classList.remove('hidden');
                iconMin.classList.add('hidden');
            } else {
                modalContent.classList.remove('md:rounded-2xl', 'max-w-4xl', 'md:h-[90vh]');
                modalContent.classList.add('fixed', 'inset-0', 'z-[60]', 'rounded-none', 'm-0', 'h-full', 'w-full');
                iconMax.classList.add('hidden');
                iconMin.classList.remove('hidden');
            }
        }

        window.downloadFlowImage = function () {
            const imgEl = document.getElementById('flow-final-image');
            if (!imgEl || !imgEl.src) return alert("Belum ada gambar untuk didownload.");
            downloadImageDirect(imgEl.src);
        }

        window.handleFlowRefUpload = function (input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = async (e) => {
                flowMagicState.refImage = e.target.result.split(',')[1];
                flowMagicState.refMime = file.type;
                const imgEl = document.getElementById('flow-ref-preview');
                const promptContainer = document.getElementById('flow-ref-prompt');

                imgEl.src = e.target.result;
                imgEl.classList.remove('hidden');
                promptContainer.classList.add('hidden');

                // --- NEW: Trigger Text Analysis Immediately ---
                const textContainer = document.getElementById('flow-text-replacement-container');
                const listContainer = document.getElementById('flow-detected-texts-list');

                textContainer.classList.remove('hidden');
                listContainer.innerHTML = `
                    <div class="flex items-center justify-center py-4 space-x-2 text-slate-500">
                        <span class="animate-spin h-4 w-4 border-2 border-purple-500 border-t-transparent rounded-full"></span>
                        <span class="text-xs">Menganalisa teks & layout...</span>
                    </div>`;

                try {
                    const detectedText = await analyzeReferenceText(flowMagicState.refImage);
                    flowMagicState.detectedText = detectedText; // Store full array/object
                    populateTextReplacementUI(detectedText);
                } catch (err) {
                    console.error("Analysis failed", err);
                    listContainer.innerHTML = `<p class="text-xs text-red-400">Gagal menganalisa teks. Silakan generate langsung.</p>`;
                }
            };
            reader.readAsDataURL(file);
        }

        window.generateFlowMagic = async function () {
            if (flowMagicState.productImages.length === 0 || !flowMagicState.refImage) {
                return alert("Mohon upload Foto Produk Utama DAN Foto Referensi Desain terlebih dahulu.");
            }

            const btn = document.getElementById('btn-gen-flow');
            const loading = document.getElementById('flow-loading');
            const resultContainer = document.getElementById('flow-result-container');
            const placeholder = document.getElementById('flow-placeholder');
            const finalImg = document.getElementById('flow-final-image');

            btn.disabled = true;
            loading.classList.remove('hidden');
            resultContainer.classList.add('hidden');
            placeholder.classList.add('hidden');

            // GATHER TEXT INPUTS
            // We read the current values from the input fields in the left column
            const textInputs = document.querySelectorAll('.replace-input');
            let textReplacements = [];

            if (textInputs.length > 0) {
                textInputs.forEach(input => {
                    textReplacements.push({
                        id: input.getAttribute('data-id'),
                        new_text: input.value
                    });
                });
            } else if (flowMagicState.detectedText && Array.isArray(flowMagicState.detectedText)) {
                // Fallback to state if UI not generated (edge case) or no inputs
                textReplacements = flowMagicState.detectedText.map(t => ({ id: t.id, new_text: t.text }));
            }

            // Construct Text Prompt Part
            let textInstruction = "NO text detected in reference.";
            if (textReplacements.length > 0) {
                textInstruction = "TEXT REPLICATION & REPLACEMENT LIST (Map these EXACTLY to the corresponding locations in reference):\n";
                textReplacements.forEach(item => {
                    // Try to find role for context
                    const originalRole = flowMagicState.detectedText?.find(t => t.id === item.id)?.role || "Text";
                    textInstruction += `- Location [${originalRole}]: Change content to "${item.new_text}"\n`;
                });
            }

            try {
                // STEP 2: GENERATE IMAGE with Strict Style Matching
                const prompt = `ACT AS A SENIOR COMMERCIAL DESIGNER & 3D ARTIST.
                TASK: REPLICATE the REFERENCE IMAGE content & style EXACTLY, but SWAP the product.
                
                STRICT REQUIREMENTS:
                1. STYLE CLONING: EXACTLY match the Layout, Fonts, Colors, Lighting, and Background of the Reference.
                2. PRODUCT INTEGRATION: Place the User's Product (${flowMagicState.productImages.length} items) in the SAME position/angle as the product in the reference.
                   - IF Reference is a 3D RENDER: YOU MUST convert the User's Product into a matching 3D Render style.
                   - IF Reference is a REAL PHOTO: Keep it photorealistic.
                   
                3. TEXT REPLICATION:
                   - You MUST include text in the EXACT SAME positions/fonts/styles as the reference.
                   - ${textInstruction}
                   - ALL other visual elements (shapes, confetti, glows) must remain identical in style.
                
                OUTPUT GOAL: A final, high-end commercial visual that looks totally indistinguishable from the reference style.`;

                const imageParts = [];
                imageParts.push({ base64: flowMagicState.refImage, mimeType: flowMagicState.refMime });
                flowMagicState.productImages.forEach(img => {
                    imageParts.push({ base64: img.base64, mimeType: img.mimeType });
                });

                let generatedBase64 = await callGeminiAdvancedAPI(prompt, "You are a world-class visual designer. Pixel-perfect replication is required.", imageParts, flowMagicState.size);

                if (generatedBase64) {
                    if (flowMagicState.logo.enabled && flowMagicState.logo.data) {
                        generatedBase64 = await applyLogoToResult(generatedBase64, flowMagicState.logo);
                    }
                    finalImg.src = generatedBase64;
                    resultContainer.classList.remove('hidden');
                } else {
                    alert("Gagal membuat desain. Silakan coba lagi.");
                    placeholder.classList.remove('hidden');
                }

            } catch (e) {
                console.error(e);
                alert("Terjadi kesalahan sistem: " + e.message);
                placeholder.classList.remove('hidden');
            } finally {
                loading.classList.add('hidden');
                btn.disabled = false;
            }
        };

        async function analyzeReferenceText(base64Image) {
            // Updated to be more aggressive in finding ALL text
            const sysPrompt = "You are an OCR & Design Expert. LIST ALL VISIBLE TEXT in the image.";
            const userPrompt = `Analyze this reference design. 
            Identify EVERY discrete text block (Headline, subhead, prices, buttons, small print, dates, brand names, etc.).
            
            Return a JSON ARRAY of objects. Each object should have:
            - "id": "t1", "t2", etc.
            - "role": Short description (e.g. "Main Headline", "Price Tag", "Footer", "Button Text").
            - "text": The EXACT text content found.
            
            Example: 
            [
              {"id": "t1", "role": "Headline", "text": "BUY 1 GET 1"},
              {"id": "t2", "role": "Subtitle", "text": "Every Monday only!"},
              {"id": "t3", "role": "Price", "text": "Rp 25.000"},
              {"id": "t4", "role": "CTA", "text": "ORDER NOW"}
            ]
            
            Return ONLY VALID JSON.`;

            try {
                const response = await callGeminiVisionText(userPrompt, sysPrompt, base64Image);
                const cleanJson = response.replace(/\`\`\`json/g, '').replace(/\`\`\`/g, '').trim();
                return JSON.parse(cleanJson);
            } catch (e) {
                console.warn("Text analysis failed", e);
                return []; // Return empty array on failure
            }

        }

        function populateTextReplacementUI(textData) {
            const listContainer = document.getElementById('flow-detected-texts-list');
            listContainer.innerHTML = '';

            if (!Array.isArray(textData) || textData.length === 0) {
                listContainer.innerHTML = '<p class="text-xs text-slate-400 italic">Tidak ada teks terdeteksi.</p>';
                return;
            }

            textData.forEach(item => {
                const div = document.createElement('div');
                div.className = "text-sm border-b border-slate-100 pb-2 last:border-0";
                div.innerHTML = `
                    <div class="flex justify-between items-center mb-1">
                        <label class="text-[10px] font-bold text-slate-500 uppercase tracking-wider bg-slate-100 px-1.5 py-0.5 rounded">${item.role || 'Text'}</label>
                        <span class="text-[10px] text-slate-400 mono" title="Original ID: ${item.id}">Original: "${item.text}"</span>
                    </div>
                    <div class="flex gap-2 items-center">
                        <input type="text" data-id="${item.id}" value="${item.text}" class="replace-input flex-1 p-2 rounded-lg border border-slate-300 focus:ring-1 focus:ring-purple-500 text-slate-800 bg-white text-sm" placeholder="Ganti teks ini...">
                    </div>
                `;
                listContainer.appendChild(div);
            });
        }



        function selectActiveImage(index, stateObj, imgEl, thumbContainerEl, type) {
            stateObj.activeIndex = index;
            let imgData;
            if (type === 'flowmagic' || type === 'product-model' || type === 'product-magic') {
                imgData = stateObj.productImages[index];
            } else {
                imgData = stateObj.images[index];
            }
            if (imgData) imgEl.src = imgData.src;
            const thumbs = thumbContainerEl.children;
            Array.from(thumbs).forEach((t, i) => {
                if (i === index) {
                    t.classList.add('thumb-selected');
                    t.classList.remove('thumb-inactive');
                } else {
                    t.classList.remove('thumb-selected');
                    t.classList.add('thumb-inactive');
                }
            });
        }
        window.toggleLogoSection = function (type, isChecked) { let state; if (type === 'product') state = productState; else if (type === 'banner') state = bannerState; else if (type === 'flowmagic') state = flowMagicState; if (state) state.logo.enabled = isChecked; const optionsDiv = document.getElementById(`logo-options-${type}`); isChecked ? optionsDiv.classList.remove('hidden') : optionsDiv.classList.add('hidden'); }
        window.handleLogoUpload = function (type, input) { if (!input.files || !input.files[0]) return; const reader = new FileReader(); reader.onload = (e) => { let state; if (type === 'product') state = productState; else if (type === 'banner') state = bannerState; else if (type === 'flowmagic') state = flowMagicState; if (state) { state.logo.data = e.target.result; document.getElementById(`logo-preview-${type}`).src = e.target.result; document.getElementById(`logo-preview-container-${type}`).classList.remove('hidden'); document.getElementById(`logo-prompt-${type}`).classList.add('hidden'); } }; reader.readAsDataURL(input.files[0]); }
        window.resetLogo = function (type) { let state; if (type === 'product') state = productState; else if (type === 'banner') state = bannerState; else if (type === 'flowmagic') state = flowMagicState; if (state) state.logo.data = null; document.getElementById(`logo-input-${type}`).value = ''; document.getElementById(`logo-preview-container-${type}`).classList.add('hidden'); document.getElementById(`logo-prompt-${type}`).classList.remove('hidden'); }
        window.updateLogoState = function (type, key, value) { let state; if (type === 'product') state = productState; else if (type === 'banner') state = bannerState; else if (type === 'flowmagic') state = flowMagicState; if (state) state.logo[key] = value; }
        window.resetUpload = function (stateObj, inputEl, containerEl, promptEl, type, thumbContainerEl) { if (type === 'flowmagic' || type === 'product-model' || type === 'product-magic') { stateObj.productImages = []; } else { stateObj.images = []; } stateObj.activeIndex = 0; if (thumbContainerEl) { thumbContainerEl.innerHTML = ''; thumbContainerEl.classList.add('hidden'); } inputEl.value = ''; containerEl.classList.add('hidden'); promptEl.classList.remove('hidden'); checkReady(type); }
        window.selectBannerSize = function (sizeId) { bannerState.sizeId = sizeId; document.querySelectorAll('#banner-size-grid .selection-card').forEach(el => el.classList.remove('selected')); document.getElementById(`size-${sizeId}`).classList.add('selected'); checkReady('banner'); };
        function getPlatformColor(platform) { if (platform === 'grab') return 'green-500'; if (platform === 'shopee') return 'orange-500'; if (platform === 'gojek') return 'green-600'; if (platform === 'youtube') return 'red-600'; if (platform === 'instagram') return 'pink-600'; if (platform === 'tiktok') return 'slate-900'; return 'slate-500'; }
        function applyLogoToResult(imageSrc, logoState) { if (!logoState.enabled || !logoState.data) return Promise.resolve(imageSrc); return new Promise((resolve) => { const canvas = document.createElement('canvas'); const ctx = canvas.getContext('2d'); const img = new Image(); img.onload = () => { canvas.width = img.width; canvas.height = img.height; ctx.drawImage(img, 0, 0); const logo = new Image(); logo.onload = () => { const logoScale = 0.2; const logoW = img.width * logoScale; const logoH = (logo.height / logo.width) * logoW; const padding = img.width * 0.05; let x, y; switch (logoState.position) { case 'top-left': x = padding; y = padding; break; case 'top-right': x = img.width - logoW - padding; y = padding; break; case 'bottom-left': x = padding; y = img.height - logoH - padding; break; case 'bottom-right': x = img.width - logoW - padding; y = img.height - logoH - padding; break; case 'center': x = (img.width - logoW) / 2; y = (img.height - logoH) / 2; break; default: x = img.width - logoW - padding; y = padding; } ctx.globalAlpha = logoState.opacity; ctx.drawImage(logo, x, y, logoW, logoH); resolve(canvas.toDataURL('image/png')); }; logo.src = logoState.data; }; img.src = imageSrc; }); }
        async function callGeminiAdvancedAPI(userPrompt, systemInstruction, imagesArray, aspectRatio = '1:1') {
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image-preview:generateContent?key=${apiKey}`;
            const parts = [{ text: userPrompt }];
            imagesArray.forEach(img => {
                if (img.base64 && img.mimeType) {
                    parts.push({ inlineData: { mimeType: img.mimeType, data: img.base64 } });
                }
            });
            const payload = {
                contents: [{ parts: parts }],
                systemInstruction: { parts: [{ text: systemInstruction }] },
                generationConfig: {
                    responseModalities: ['IMAGE'],
                    aspectRatio: aspectRatio
                }
            };
            let retries = 3;
            while (retries > 0) {
                try {
                    const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    if (response.ok) {
                        const result = await response.json();
                        const base64 = result?.candidates?.[0]?.content?.parts?.find(p => p.inlineData)?.inlineData?.data;
                        return base64 ? `data:image/png;base64,${base64}` : null;
                    }
                } catch (e) { console.error(e); }
                retries--;
                await new Promise(r => setTimeout(r, 1000));
            }
            return null;
        }

        // --- UPDATED: SOCIAL KIT LOGIC (WITH IMAGE ANALYSIS) ---
        window.openSocialKitModal = async function (specificImgSrc) {
            const productName = (currentView === 'product')
                ? (document.getElementById('product-name-input').value || "Produk Kuliner")
                : (document.getElementById('banner-product-name')?.value || "Produk Kuliner");

            const styleId = (currentView === 'product') ? productState.styleId : bannerState.styleId;
            const style = styles.find(s => s.id === styleId)?.name || "Profesional";

            const modal = document.getElementById('social-kit-modal');
            const loading = document.getElementById('social-kit-loading');
            const content = document.getElementById('social-kit-content');

            modal.classList.remove('hidden');
            loading.classList.remove('hidden');
            content.classList.add('hidden');

            try {
                const sysPrompt = "Anda adalah Copywriter Profesional spesialis Lifestyle & F&B dengan Target Audience Gen Z & Millennials (18-40 tahun). TUGAS: Analisa gambar dan buat Caption yang SANGAT RELATE dengan behavior/pain points audiens (misal: mager, tugas numpuk, butuh healing, senin berat, weekend santai). POSITIONING: Produk ini hadir sebagai SOLUSI/Mood Booster yang membawa keceriaan. TONALITY: Asik, Akrab, Kekinian (bisa slang halus/sapaan bestie), Profesional. PENTING: Fokus ke 'emotional connection' dengan audiens, jangan terlalu kaku/hard-selling.";
                const userPrompt = `Produk: "${productName}". Buatkan Social Kit (Caption + Hashtags) dalam format JSON.
                PASTIKAN:
                1. Caption nyambung dengan situasi/masalah audiens saat ini (Relateable Content).
                2. Produk disebut sebagai solusi penyemangat/teman aktivitas.
                3. Hashtag relevan dgn behavior audiens + branding produk.
                JSON Format: {"caption": "...", "hashtags": "..."}`;

                // Extract base64 from current result image
                const base64Data = specificImgSrc.split(',')[1];

                const response = await callGeminiVisionText(userPrompt, sysPrompt, base64Data);
                let data = { caption: "Gagal memuat caption", hashtags: "#viral" };
                try {
                    const cleanJson = response.replace(/```json/g, '').replace(/```/g, '').trim();
                    data = JSON.parse(cleanJson);
                } catch (e) {
                    data.caption = response;
                }

                document.getElementById('viral-caption-text').innerText = data.caption;
                document.getElementById('viral-hashtag-text').innerText = data.hashtags;

                loading.classList.add('hidden');
                content.classList.remove('hidden');
            } catch (e) {
                console.error(e);
                alert("Gagal membuat social kit.");
                closeSocialKitModal();
            }
        };

        window.closeSocialKitModal = function () {
            document.getElementById('social-kit-modal').classList.add('hidden');
        };

        // --- NEW: MOTION & NARRATION LOGIC ---

        window.openMotionModal = async function (specificImgSrc) {
            const modal = document.getElementById('motion-modal');
            const loading = document.getElementById('motion-loading');
            const content = document.getElementById('motion-content');

            modal.classList.remove('hidden');
            loading.classList.remove('hidden');
            content.classList.add('hidden');

            try {
                const sysPrompt = "You are a Cinematography Expert & AI Video Director. Analisa gambar yang diberikan dan tentukan SATU pergerakan kamera (Camera Movement) terbaik untuk membuat gambar ini menjadi video iklan yang dinamis.";
                const userPrompt = `Analisa gambar ini. 
                1. Tentukan jenis gerakan kamera terbaik (pilih satu: Pan Right, Pan Left, Zoom In, Zoom Out, Tilt Up, Tilt Down, Orbit).
                2. Berikan alasan singkat kenapa gerakan ini cocok.
                3. Buatkan Prompt JSON untuk tool video AI (seperti Runway/Pika/Luma) dalam format: {"motion_type": "TYPE", "description": "reason", "json_prompt": "{ camera_motion: ... }"}.
                Pastikan output valid JSON only.`;

                const base64Data = specificImgSrc.split(',')[1];
                const response = await callGeminiVisionText(userPrompt, sysPrompt, base64Data);

                let data = { motion_type: "ZOOM IN", description: "Menonjolkan detail produk.", json_prompt: "{}" };
                try {
                    const cleanJson = response.replace(/```json/g, '').replace(/```/g, '').trim();
                    data = JSON.parse(cleanJson);
                } catch (e) {
                    data.description = response;
                }

                document.getElementById('motion-type-tag').innerText = data.motion_type || "AUTO";
                document.getElementById('motion-desc-text').innerText = data.description;
                document.getElementById('motion-json-text').innerText = JSON.stringify(data.json_prompt, null, 2);

                loading.classList.add('hidden');
                content.classList.remove('hidden');
            } catch (e) {
                console.error(e);
                alert("Gagal menganalisa motion.");
                closeMotionModal();
            }
        };

        window.closeMotionModal = function () {
            document.getElementById('motion-modal').classList.add('hidden');
        };

        window.openNarrationModal = async function (specificImgSrc) {
            const modal = document.getElementById('narration-modal');
            const loading = document.getElementById('narration-loading');
            const content = document.getElementById('narration-content');

            modal.classList.remove('hidden');
            loading.classList.remove('hidden');
            content.classList.add('hidden');

            try {
                const productName = (currentView === 'product')
                    ? (document.getElementById('product-name-input').value || "Produk")
                    : (document.getElementById('banner-product-name')?.value || "Produk");

                const sysPrompt = "You are a Professional Copywriter & Video Director. Analisa gambar. Jika ada Muka/Orang, naskah harus gaya 'Talking Head/UGC' dimana model berbicara langsung ke kamera. Jika hanya benda, gunakan Voiceover. DURASI TOTAL MAKSIMAL 7-8 DETIK.";
                const userPrompt = `Produk: ${productName}.
                Analisa gambar ini:
                1. Jika ada manusia: Buatkan dialog pendek seolah-olah dia sedang berbicara ke followers (UGC Style). Bahasa santai/akrab.
                2. Jika benda mati: Buatkan voiceover iklan yang estetik.
                3. PENTING: Wajib pas dalam 7-8 detik (maksimal 2 kalimat pendek).
                4. Tentukan Tone.
                Format JSON output: {"script": "teks...", "tags": ["UGC", "Ceria"], "audio_prompt": {"text": "...", "voice_stability": 0.5}}`;

                const base64Data = specificImgSrc.split(',')[1];
                const response = await callGeminiVisionText(userPrompt, sysPrompt, base64Data);

                let data = { script: "Gagal memuat naskah.", tags: [], audio_prompt: {} };
                try {
                    const cleanJson = response.replace(/```json/g, '').replace(/```/g, '').trim();
                    data = JSON.parse(cleanJson);
                } catch (e) {
                    data.script = response;
                }

                document.getElementById('narration-text').innerText = data.script;

                const tagsContainer = document.getElementById('narration-tags');
                tagsContainer.innerHTML = '';
                if (data.tags && Array.isArray(data.tags)) {
                    data.tags.forEach(tag => {
                        tagsContainer.innerHTML += `<span class="px-2 py-1 bg-teal-100 text-teal-700 text-[10px] rounded-md font-bold uppercase">${tag}</span>`;
                    });
                }

                document.getElementById('narration-json-text').innerText = JSON.stringify(data.audio_prompt, null, 2);

                loading.classList.add('hidden');
                content.classList.remove('hidden');
            } catch (e) {
                console.error(e);
                alert("Gagal membuat narasi.");
                closeNarrationModal();
            }
        };

        window.closeNarrationModal = function () {
            document.getElementById('narration-modal').classList.add('hidden');
        };

        async function callGeminiVisionText(prompt, systemPrompt = "", base64Image) {
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            const payload = {
                contents: [{
                    parts: [
                        { text: prompt },
                        { inlineData: { mimeType: "image/png", data: base64Image } }
                    ]
                }],
                systemInstruction: { parts: [{ text: systemPrompt }] }
            };
            try {
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                const result = await response.json();
                return result.candidates[0].content.parts[0].text;
            } catch (e) {
                return "Error generating vision content";
            }
        }

        async function callGeminiText(prompt, systemPrompt = "") {
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] }
            };
            try {
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                const result = await response.json();
                return result.candidates[0].content.parts[0].text;
            } catch (e) {
                return "Error generating text content";
            }
        }

        function createResultCard(imgSrc, idx, ratio) {
            const ratioStyle = ratio === '1:1' ? 'aspect-ratio: 1/1;' : `aspect-ratio: ${ratio.replace(':', '/')};`;
            return `
                <div class="group relative rounded-xl overflow-hidden shadow-lg bg-slate-200">
                    <img src="${imgSrc}" style="${ratioStyle} width: 100%; object-fit: cover;" alt="Result ${idx + 1}">
                    <div class="absolute inset-0 bg-black/60 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center gap-2 flex-wrap content-center p-4">
                        <div class="flex gap-2">
                             <button onclick="openPreviewModal('${imgSrc}')" class="bg-white text-slate-700 p-2 rounded-full hover:bg-purple-50 transition shadow-lg" title="Preview">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" /></svg>
                            </button>
                            <button onclick="downloadImageDirect('${imgSrc}')" class="bg-white text-blue-600 p-2 rounded-full hover:bg-blue-50 transition shadow-lg" title="Download">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
                            </button>
                            <button onclick="openEditModal('${imgSrc}')" class="bg-white text-purple-600 p-2 rounded-full hover:bg-purple-50 transition shadow-lg" title="Edit">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" /></svg>
                            </button>
                        </div>
                        <div class="flex gap-2 mt-2">
                             <button onclick="openSocialKitModal('${imgSrc}')" class="bg-gradient-to-r from-purple-600 to-pink-500 text-white p-2 rounded-full hover:scale-110 transition shadow-lg border border-white/20" title="Viral Social Kit">
                                <span class="text-[10px] font-black px-1">Viral</span>
                            </button>
                            <button onclick="openMotionModal('${imgSrc}')" class="bg-gradient-to-r from-blue-600 to-indigo-600 text-white p-2 rounded-full hover:scale-110 transition shadow-lg border border-white/20" title="Motion Suggestion">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg>
                            </button>
                            <button onclick="openNarrationModal('${imgSrc}')" class="bg-gradient-to-r from-teal-500 to-green-500 text-white p-2 rounded-full hover:scale-110 transition shadow-lg border border-white/20" title="Narration Gen">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" /></svg>
                            </button>
                        </div>
                    </div>
                </div>`;
        }

        window.openPreviewModal = function (imgSrc) { document.getElementById('preview-image-full').src = imgSrc; document.getElementById('preview-modal').classList.remove('hidden'); }
        window.closePreviewModal = function () { document.getElementById('preview-modal').classList.add('hidden'); }
        window.downloadImageDirect = function (imgSrc) { const link = document.createElement('a'); link.href = imgSrc; link.download = 'flowpict-' + Date.now() + '.png'; document.body.appendChild(link); link.click(); document.body.removeChild(link); }
        window.openEditModal = function (imgSrc) { currentEditingImage = imgSrc; document.getElementById('edit-source-img').src = imgSrc; document.getElementById('edit-modal').classList.remove('hidden'); document.getElementById('edit-prompt-input').value = ''; document.getElementById('btn-save-edit').classList.add('hidden'); }
        window.closeEditModal = function () { document.getElementById('edit-modal').classList.add('hidden'); currentEditingImage = null; }
        window.saveEditedImage = function () { downloadImageDirect(document.getElementById('edit-source-img').src); alert("Gambar berhasil disimpan!"); }
        window.processEdit = async function () { const prompt = document.getElementById('edit-prompt-input').value; if (!prompt || !currentEditingImage) return alert("Mohon masukkan instruksi edit."); document.getElementById('edit-loading').classList.remove('hidden'); const base64Data = currentEditingImage.split(',')[1]; const finalPrompt = `Edit this image based on user instruction: "${prompt}". Maintain the original style and composition. Do not distort the main food item.`; try { const editedBase64 = await callGeminiAPI(finalPrompt, "You are an expert photo editor.", base64Data, "image/png"); if (editedBase64) { document.getElementById('edit-source-img').src = editedBase64; currentEditingImage = editedBase64; document.getElementById('btn-save-edit').classList.remove('hidden'); } else { alert("Gagal mengedit gambar."); } } catch (e) { console.error(e); } finally { document.getElementById('edit-loading').classList.add('hidden'); } };

        async function callGeminiAPI(userPrompt, systemInstruction, base64ImageData, mimeType) { const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image-preview:generateContent?key=${apiKey}`; const payload = { contents: [{ parts: [{ text: userPrompt }, { inlineData: { mimeType: mimeType, data: base64ImageData } }] }], systemInstruction: { parts: [{ text: systemInstruction }] }, generationConfig: { responseModalities: ['IMAGE'] } }; let retries = 3; while (retries > 0) { try { const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) }); if (response.ok) { const result = await response.json(); const base64 = result?.candidates?.[0]?.content?.parts?.find(p => p.inlineData)?.inlineData?.data; return base64 ? `data:image/png;base64,${base64}` : null; } } catch (e) { } retries--; await new Promise(r => setTimeout(r, 1000)); } return null; }

        window.generateProductPhotos = async function () { const btn = document.getElementById('btn-gen-product'); const loading = document.getElementById('product-loading'); const results = document.getElementById('product-results'); const imagesToProcess = productState.images.length > 0 ? productState.images : []; if (imagesToProcess.length === 0) return alert("Upload foto produk dulu ya!"); btn.disabled = true; loading.classList.remove('hidden'); results.classList.add('hidden'); results.innerHTML = ''; const style = styles.find(s => s.id === productState.styleId); const ratio = productState.ratio || '1:1'; let promptText = style.prompt; let systemInst = "You are a pro food photographer."; if (imagesToProcess.length > 1) { promptText = `Combine these ${imagesToProcess.length} different food products into a single, cohesive professional food photography composition. Style: ${style.name}. ${style.desc}. Arrange them naturally together. Ensure consistent lighting and perspective. Aspect ratio ${ratio}. ONE single image. NO collage grids.`; if (productState.productName) promptText += `\n\n**CONTEXT:** The products are related to "${productState.productName}".`; } else { if (productState.styleId === 'commercial' && productState.productName) promptText += `\n\n**CONTEXT:** The product is "${productState.productName}". Ensure strictly relevant props.`; promptText += `\n\n**INSTRUCTION:** Aspect ratio ${ratio}. ONE single image. NO collage. UPRIGHT product.`; } try { const promises = Array(4).fill(null).map(() => callGeminiAdvancedAPI(promptText, systemInst, imagesToProcess, ratio)); const rawImages = (await Promise.all(promises)).filter(img => img !== null); if (rawImages.length === 0) throw new Error("No images"); const finalImages = await Promise.all(rawImages.map(img => applyLogoToResult(img, productState.logo))); finalImages.forEach((imgSrc, idx) => { results.innerHTML += createResultCard(imgSrc, idx, ratio); }); results.classList.remove('hidden'); } catch (err) { console.error(err); alert("Gagal membuat gambar. Coba lagi."); } finally { loading.classList.add('hidden'); btn.disabled = false; } };
        window.generateBannerPhotos = async function () { const btn = document.getElementById('btn-gen-banner'); const loading = document.getElementById('banner-loading'); const results = document.getElementById('banner-results'); const imagesToProcess = bannerState.images.length > 0 ? bannerState.images : []; if (imagesToProcess.length === 0) return alert("Upload foto produk dulu ya!"); btn.disabled = true; loading.classList.remove('hidden'); results.classList.add('hidden'); results.innerHTML = ''; const style = styles.find(s => s.id === bannerState.styleId); const sizeObj = ojolSizes.find(s => s.id === bannerState.sizeId); const headerText = bannerState.header || ""; const subHeaderText = bannerState.subHeader || ""; let promptText = ""; let systemInst = "You are a pro food photographer. Focus on clean, appetizing food photography."; if (imagesToProcess.length > 1) { promptText = `Combine these ${imagesToProcess.length} food items into a single, cohesive professional food photography composition. Style: ${style.name}. ${style.desc}. Arrange them naturally. Ensure consistent lighting. Aspect ratio ${sizeObj.ratio}. ONE single image. NO collage grids.`; } else { promptText = `${style.prompt}. Aspect ratio ${sizeObj.ratio}. ONE single image. UPRIGHT product.`; } if (headerText || subHeaderText) { promptText += `\n\n**OPTIONAL OVERLAY:** Include clean, legible text overlay in negative space if possible: - Headline: "${headerText}" - Subheadline: "${subHeaderText}"`; } else { promptText += `\n\n**INSTRUCTION:** Pure photography. No text overlays.`; } if (bannerState.productName) promptText += `\n\n**CONTEXT:** The products are "${bannerState.productName}".`; try { const promises = Array(4).fill(null).map(() => callGeminiAdvancedAPI(promptText, systemInst, imagesToProcess)); const rawImages = (await Promise.all(promises)).filter(img => img !== null); if (rawImages.length === 0) throw new Error("No images"); const finalImages = await Promise.all(rawImages.map(img => applyLogoToResult(img, bannerState.logo))); finalImages.forEach((imgSrc, idx) => { results.innerHTML += createResultCard(imgSrc, idx, sizeObj.ratio); }); results.classList.remove('hidden'); } catch (err) { console.error(err); alert("Gagal membuat banner. Coba lagi."); } finally { loading.classList.add('hidden'); btn.disabled = false; } };

        window.copyToClipboard = function (text) {
            const textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.position = "fixed";
            textArea.style.left = "-9999px";
            textArea.style.top = "0";
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            try {
                const successful = document.execCommand('copy');
                if (successful) { alert('Berhasil disalin ke clipboard!'); }
            } catch (err) { console.error('Fallback copy failed', err); }
            document.body.removeChild(textArea);
        };


        // --- PROFESSIONAL ADS / DIRECTOR MODE LOGIC ---

        const commercialState = {
            productImages: [], // changed from single productImage
            modelImage: null,
            envImage: null,
            ratio: '16:9',
            themeId: 'cinematic',
            style: "Cinematic & High-End",
            sceneCount: 6,
            language: 'id_formal',
            voice: 'Zephyr',
            pitch: 0,
            brief: "",
            generatedScenes: [], // Store scene data for downloads
            fullNarration: ""
        };

        const adThemes = [
            { id: 'cinematic', name: 'Cinematic', icon: 'üé¨', desc: 'Dramatic lighting, bokeh, high production value', prompt: 'Cinematic commercial shot, dramatic lighting, 8k resolution, Arri Alexa style, depth of field.' },
            { id: 'fresh', name: 'Fresh & Pop', icon: 'üçã', desc: 'Bright colors, high energy, sharp focus', prompt: 'Bright pop art aestethic, high saturation, sharp focus, studio lighting, advertising photography.' },
            { id: 'minimal', name: 'Minimalist', icon: '‚ö™', desc: 'Clean, negative space, elegant', prompt: 'Minimalist luxury aesthetic, soft shadows, clean background, apple style advertisement, elegance.' },
            { id: 'lifestyle', name: 'Lifestyle', icon: 'üåø', desc: 'Natural light, relatable context', prompt: 'Lifestyle photography, natural sunlight, golden hour, authentic look, relatable context.' },
            { id: 'luxury', name: 'Luxury Gold', icon: '‚ú®', desc: 'Dark, gold accents, premium feel', prompt: 'Luxury product photography, black and gold color palette, premium textures, elegant lighting.' },
            { id: 'cyber', name: 'Cyberpunk', icon: 'ü¶æ', desc: 'Neon lights, futuristic, tech', prompt: 'Cyberpunk aesthetic, neon lighting, blue and pink gradients, futuristic tech vibes.' }
        ];

        window.renderAdVideoView = function () {
            // Render Themes
            const themeGrid = document.getElementById('ad-theme-grid');
            if (themeGrid) {
                themeGrid.innerHTML = adThemes.map(t => `
                    <div onclick="selectAdTheme('${t.id}')" id="ad-theme-${t.id}" 
                         class="selection-card rounded-xl p-2 cursor-pointer text-center flex flex-col items-center justify-center gap-1 border border-transparent hover:bg-slate-50 transition-all ${t.id === commercialState.themeId ? 'selected border-purple-500 bg-purple-50' : ''}">
                        <div class="text-2xl">${t.icon}</div>
                        <div class="text-[10px] font-bold text-slate-700">${t.name}</div>
                    </div>
                `).join('');
            }
        };

        window.selectAdTheme = function (id) {
            commercialState.themeId = id;
            commercialState.style = adThemes.find(t => t.id === id).desc;
            document.querySelectorAll('#ad-theme-grid .selection-card').forEach(el => {
                el.classList.remove('selected', 'border-purple-500', 'bg-purple-50');
            });
            document.getElementById(`ad-theme-${id}`).classList.add('selected', 'border-purple-500', 'bg-purple-50');
        };

        window.selectAdRatio = function (ratio) {
            commercialState.ratio = ratio;
            document.querySelectorAll('.ratio-card').forEach(el => el.classList.remove('selected', 'border-purple-500', 'bg-purple-50'));
            // IDs are ratio-9-16, ratio-16-9, ratio-1-1
            const idMap = { '9:16': 'ratio-9-16', '16:9': 'ratio-16-9', '1:1': 'ratio-1-1' };
            const el = document.getElementById(idMap[ratio]);
            if (el) el.classList.add('selected', 'border-purple-500', 'bg-purple-50');
        };

        // Upload Handlers
        // Upload Handlers
        window.handleAdProductUpload = function (input) {
            const files = Array.from(input.files).slice(0, 5);
            if (files.length === 0) return;
            commercialState.productImages = [];
            const container = document.getElementById('ad-product-thumbs');
            const prompt = document.getElementById('ad-product-prompt');
            container.innerHTML = '';

            files.forEach((file, idx) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    commercialState.productImages.push({ base64: e.target.result.split(',')[1], mimeType: file.type });
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.className = "w-full h-12 object-cover rounded-md border border-slate-200";
                    container.appendChild(img);
                };
                reader.readAsDataURL(file);
            });

            prompt.classList.add('hidden');
            container.classList.remove('hidden');
        };

        window.handleAdModelUpload = function (input) { handleSingleUpload(input, 'modelImage', 'ad-model-preview', 'ad-model-prompt'); };
        window.handleAdEnvUpload = function (input) { handleSingleUpload(input, 'envImage', 'ad-env-preview', 'ad-env-prompt'); };

        function handleSingleUpload(input, stateKey, previewId, promptId) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                commercialState[stateKey] = { base64: e.target.result.split(',')[1], mimeType: file.type };
                const img = document.getElementById(previewId);
                img.src = e.target.result;
                img.classList.remove('hidden');
                document.getElementById(promptId).classList.add('hidden');
            };
            reader.readAsDataURL(file);
        }

        // Logic
        window.generateVideoAd = async function () {
            // Gather Inputs
            commercialState.industry = document.getElementById('ad-industry').value;
            const customConcept = document.getElementById('ad-concept').value;
            const sceneCountParam = document.querySelector('input[name="scene-count"]:checked')?.value || 5;

            // Ratio is already updated via selectAdRatio, default if not set
            if (!commercialState.ratio) commercialState.ratio = '9:16';
            // Theme ID is already set via selectAdTheme

            const btn = document.getElementById('btn-gen-video');
            const loading = document.getElementById('video-loading');
            const resultDiv = document.getElementById('video-result');
            const loadingStage = document.getElementById('loading-stage');
            const loadingDetail = document.getElementById('loading-detail');
            const progress = document.getElementById('progress-percent');
            const sceneGrid = document.getElementById('ad-scenes-grid');

            if (commercialState.productImages.length === 0) return alert("Wajib upload minimal 1 Foto Produk!");

            btn.disabled = true;
            loading.classList.remove('hidden');
            resultDiv.classList.add('hidden');
            document.getElementById('ad-placeholder-result').classList.add('hidden');
            sceneGrid.innerHTML = ''; // Clear previous

            // Helper for updates
            const updateProgress = (pct, stage, detail) => {
                progress.innerText = pct + '%';
                loadingStage.innerText = stage;
                loadingDetail.innerText = detail;
            };

            try {
                // STEP 1: AI DIRECTOR (Script & Visual Plan)
                updateProgress(10, "Creative Director Berpikir...", `Merancang storyboard ${sceneCountParam} scene...`);

                const themeObj = adThemes.find(t => t.id === commercialState.themeId) || adThemes[0];
                const conceptText = customConcept ? `User Concept: "${customConcept}".` : "";

                const sysPrompt = `You are a World-Class Creative Director. 
                Task: Create a ${sceneCountParam}-Scene Storyboard for a commercial video.
                Product Industry: "${commercialState.industry}".
                Theme: ${themeObj.name} (${themeObj.desc}).
                Target Audience: Indonesia.
                ${conceptText}
                
                IMPORTANT:
                - Generate exactly ${sceneCountParam} scenes.
                - Each scene MUST be 7-8 seconds long. SPECIFY THIS IN THE PROMPT.
                - The "video_gen_prompt" must include "Duration: 8s" or similar instruction for the video generator.
                
                The user provided ${commercialState.productImages.length} product images. Use them wisely.
                If Model Image is provided, use it as character ref.
                If Env Image is provided, use it as background ref.
                
                OUTPUT JSON ONLY (as defined previously).`;

                const userPrompt = "Create Storyboard & Asset Plan.";

                // Collect all reference images for Vision
                let referenceImages = [...commercialState.productImages];
                if (commercialState.modelImage) referenceImages.push(commercialState.modelImage);
                if (commercialState.envImage) referenceImages.push(commercialState.envImage);

                let planJSON = await callGeminiVisionTextJSON(userPrompt, sysPrompt, referenceImages);

                if (typeof planJSON === 'string') {
                    try { planJSON = JSON.parse(planJSON.replace(/```json/g, '').replace(/```/g, '').trim()); }
                    catch (e) { throw new Error("Gagal parsing konsep video."); }
                }
                console.log("Plan:", planJSON);

                // Save Full Narration
                commercialState.fullNarration = planJSON.scenes.map(s => s.audio_script).join(' ');
                document.getElementById('ad-script-text').innerText = commercialState.fullNarration;

                // STEP 2: GENERATE ASSETS (Visuals)
                updateProgress(30, "Produksi Aset Visual...", `Mengenerate ${sceneCountParam} Scene High-Quality...`);

                commercialState.generatedScenes = []; // Reset

                // Process Scenes Sequentially (or parallel chunks) to avoid rate limits? 
                // Parallel is faster for user.
                const scenePromises = planJSON.scenes.map(async (scene, idx) => {
                    const p = `Shot Scene ${idx + 1}. ${scene.visual_desc}. Style: ${themeObj.prompt}. High Quality, 4k, Professional Lighting. Product: Match reference. AR: ${commercialState.ratio}.`;

                    // Call Gemini Advanced
                    const base64 = await callGeminiAdvancedAPI(p, "Commercial Photographer / Render Artist", referenceImages, commercialState.ratio);

                    return {
                        id: idx,
                        image: base64,
                        desc: scene.visual_desc,
                        script: scene.audio_script,
                        jsonPrompt: scene.video_gen_prompt
                    };
                });

                const results = await Promise.all(scenePromises);

                // STEP 3: RENDER UI
                updateProgress(90, "Finishing...", "Menyusun aset...");

                const gridHtml = results.map((scene, i) => {
                    commercialState.generatedScenes.push(scene);
                    return createSceneCard(scene, i);
                }).join('');

                sceneGrid.innerHTML = gridHtml;

                // Helper to create Scene Card HTML
                function createSceneCard(scene, idx) {
                    // We use the index to reference the global state commercialState.generatedScenes[idx]
                    // to avoid putting large Base64 strings in the DOM.
                    const jsonString = encodeURIComponent(JSON.stringify(scene.jsonPrompt, null, 2));

                    return `
                    <div class="card bg-white rounded-xl shadow-md border border-slate-100 overflow-hidden flex flex-col md:flex-row animate-fade-in">
                        <!-- Image -->
                        <div class="relative w-full md:w-1/3 bg-slate-100 group cursor-pointer" onclick="openPreviewModalByIndex(${idx})">
                             <img src="${scene.image}" class="w-full h-full object-cover aspect-video md:aspect-auto">
                             <div class="absolute top-2 left-2 bg-black/60 text-white text-[10px] px-2 py-0.5 rounded-full font-bold">Scene ${idx + 1}</div>
                             <div class="absolute inset-0 bg-black/20 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center">
                                <span class="text-white font-bold text-sm">üîç View Full</span>
                             </div>
                        </div>
                        
                        <!-- Details -->
                        <div class="p-4 flex-1 flex flex-col justify-between">
                            <div>
                                <h5 class="font-bold text-slate-800 mb-1">Visual Description</h5>
                                <p class="text-xs text-slate-600 mb-3 line-clamp-2">${scene.desc}</p>
                                
                                <h5 class="font-bold text-slate-800 mb-1">Narration (Script)</h5>
                                <p class="text-xs text-slate-600 italic mb-3 bg-slate-50 p-2 rounded border border-slate-100">"${scene.script}"</p>
                            </div>
                            
                            <!-- Actions -->
                            <div class="flex flex-wrap gap-2 mt-2">
                                <button onclick="downloadImageByIndex(${idx})" class="flex items-center gap-1 bg-slate-100 hover:bg-slate-200 text-slate-600 px-3 py-1.5 rounded-lg text-xs font-bold transition">
                                    ‚¨áÔ∏è Image
                                </button>
                                <button onclick="openEditModalByIndex(${idx})" class="flex items-center gap-1 bg-purple-50 hover:bg-purple-100 text-purple-600 px-3 py-1.5 rounded-lg text-xs font-bold transition">
                                    ‚úèÔ∏è Edit
                                </button>
                                <button onclick="viewAdJsonPrompt('${jsonString}')" class="flex items-center gap-1 bg-gradient-to-r from-blue-500 to-indigo-600 text-white px-3 py-1.5 rounded-lg text-xs font-bold transition shadow-sm hover:shadow-md">
                                    üìã JSON Prompt
                                </button>
                            </div>
                        </div>
                    </div>`;
                }

                // Show Result
                loading.classList.add('hidden');
                resultDiv.classList.remove('hidden');

            } catch (e) {
                console.error(e);
                alert("Gagal membuat aset kreatif: " + e.message);
                loading.classList.add('hidden');
                document.getElementById('ad-placeholder-result').classList.remove('hidden');
            } finally {
                btn.disabled = false;
            }
        };

        // Helper functions for Scene Actions
        window.openPreviewModalByIndex = function (idx) {
            const scene = commercialState.generatedScenes[idx];
            if (scene) openPreviewModal(scene.image);
        };

        window.downloadImageByIndex = function (idx) {
            const scene = commercialState.generatedScenes[idx];
            if (scene) {
                const a = document.createElement('a');
                a.href = scene.image;
                a.download = `scene_${idx + 1}_${Date.now()}.png`;
                document.body.appendChild(a);
                a.click();
            }
        };

        window.openEditModalByIndex = function (idx) {
            const scene = commercialState.generatedScenes[idx];
            if (scene) openEditModal(scene.image);
        };

        async function callGeminiVisionTextJSON(prompt, system, images) {
            // Helper to get text/json from Vision model
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            const parts = [{ text: prompt }];
            images.forEach(img => parts.push({ inlineData: { mimeType: img.mimeType, data: img.base64 } }));

            const payload = {
                contents: [{ parts: parts }],
                systemInstruction: { parts: [{ text: system }] },
                generationConfig: { responseMimeType: "application/json" } // Force JSON
            };

            const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            const result = await response.json();
            return JSON.parse(result.candidates[0].content.parts[0].text);
        }

        // --- CANVAS RENDERER ENGINE ---
        async function renderVideoFromImages(assets, ratioStr) {
            const canvas = document.getElementById('video-render-canvas');
            const ctx = canvas.getContext('2d');

            // Set resolution based on ratio
            let width = 1080;
            let height = 1920;
            if (ratioStr === '16:9') { width = 1920; height = 1080; }
            if (ratioStr === '1:1') { width = 1080; height = 1080; }

            canvas.width = width;
            canvas.height = height;

            // Load Images
            const images = await Promise.all(assets.map(a => loadImage(a.base64)));

            // Setup MediaRecorder
            const stream = canvas.captureStream(30); // 30 FPS
            const mimeType = MediaRecorder.isTypeSupported('video/webm; codecs=vp9')
                ? 'video/webm; codecs=vp9'
                : 'video/webm';
            const recorder = new MediaRecorder(stream, { mimeType, videoBitsPerSecond: 5000000 }); // 5Mbps

            const chunks = [];
            recorder.ondataavailable = e => chunks.push(e.data);

            return new Promise((resolve, reject) => {
                recorder.onstop = () => {
                    const blob = new Blob(chunks, { type: 'video/webm' });
                    resolve(blob);
                };

                recorder.start();

                // Animation Loop Parameters
                const durationPerScene = 3000; // 3 seconds per scene
                const totalDuration = assets.length * durationPerScene;
                let startTime = null;

                function animate(time) {
                    if (!startTime) startTime = time;
                    const elapsed = time - startTime;

                    if (elapsed >= totalDuration) {
                        recorder.stop();
                        return;
                    }

                    // Determine current scene
                    const sceneIdx = Math.floor(elapsed / durationPerScene);
                    const sceneTime = elapsed % durationPerScene;
                    const progress = sceneTime / durationPerScene; // 0 to 1

                    if (sceneIdx < images.length) {
                        const img = images[sceneIdx];
                        const motion = assets[sceneIdx].motion;

                        // Clear
                        ctx.fillStyle = '#000';
                        ctx.fillRect(0, 0, width, height);

                        // Calculate transform based on motion type
                        let scale = 1;
                        let tx = 0, ty = 0;

                        // Ken Burns Effect Logic
                        if (motion.includes('zoom_in')) {
                            scale = 1 + (progress * 0.15); // Scale 1.0 to 1.15
                        } else if (motion.includes('zoom_out')) {
                            scale = 1.15 - (progress * 0.15);
                        } else if (motion.includes('pan_right')) {
                            scale = 1.1;
                            tx = -(progress * (width * 0.1)); // Move Left to simulate Pan Right
                        } else if (motion.includes('pan_left')) {
                            scale = 1.1;
                            tx = -((1 - progress) * (width * 0.1));
                        } else {
                            // Default subtle zoom
                            scale = 1 + (progress * 0.05);
                        }

                        // Draw Image with transform
                        // We need to center crop and scale
                        const imgAspect = img.width / img.height;
                        const canvasAspect = width / height;

                        let drawW, drawH, drawX, drawY;

                        if (imgAspect > canvasAspect) {
                            // Image is wider than canvas
                            drawH = height * scale;
                            drawW = drawH * imgAspect;
                            drawY = (height - drawH) / 2;
                            drawX = (width - drawW) / 2 + tx;
                        } else {
                            // Image is taller than canvas
                            drawW = width * scale;
                            drawH = drawW / imgAspect;
                            drawX = (width - drawW) / 2 + tx;
                            drawY = (height - drawH) / 2;
                        }

                        ctx.drawImage(img, drawX, drawY, drawW, drawH);

                        // Optional: Fade Transition
                        if (sceneTime < 500 && sceneIdx > 0) {
                            ctx.fillStyle = `rgba(0,0,0,${1 - (sceneTime / 500)})`;
                            ctx.fillRect(0, 0, width, height);
                        }
                    }

                    requestAnimationFrame(animate);
                }

                requestAnimationFrame(animate);
            });
        }

        function loadImage(src) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.crossOrigin = "anonymous";
                img.onload = () => resolve(img);
                img.onerror = reject;
                img.src = src;
            });
        }

        window.downloadFinalVideo = function () {
            if (!window.lastGeneratedVideoBlob) return;
            const url = URL.createObjectURL(window.lastGeneratedVideoBlob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            a.download = `flowpict_commercial_${Date.now()}.webm`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
        };

        window.shareVideo = function () {
            alert("Fitur Share ke TikTok sedang dalam pengembangan! Silakan download video terlebih dahulu.");
        }

        // --- END VIDEO GENERATOR LOGIC ---


        // --- CHAT LOGIC ---
        window.callGeminiTextAPI = async function (prompt, systemInstruction) {
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=${apiKey}`;
            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                systemInstruction: { parts: [{ text: systemInstruction }] }
            };
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload)
                });
                if (response.ok) {
                    const result = await response.json();
                    return result?.candidates?.[0]?.content?.parts?.[0]?.text || "Maaf, Flow sedang gangguan.";
                }
            } catch (e) { console.error(e); }
            return "Maaf, terjadi kesalahan koneksi.";
        };

        window.sendChatMessage = async function () {
            const input = document.getElementById('chat-input');
            const history = document.getElementById('chat-history');
            const msg = input.value.trim();
            if (!msg) return;

            // User Message
            history.innerHTML += `
                <div class="flex gap-3 justify-end">
                    <div class="bg-purple-600 p-3 rounded-2xl rounded-tr-none shadow-sm text-sm text-white max-w-[80%]">
                        ${msg}
                    </div>
                </div>
            `;
            input.value = '';
            history.scrollTop = history.scrollHeight;

            // Loading
            const loadingId = 'chat-loading-' + Date.now();
            history.innerHTML += `
                <div id="${loadingId}" class="flex gap-3">
                     <div class="w-8 h-8 rounded-full bg-purple-100 flex items-center justify-center text-purple-600 text-xs font-bold shrink-0">Flow</div>
                     <div class="bg-white p-3 rounded-2xl rounded-tl-none shadow-sm text-sm text-slate-500 max-w-[80%] italic">
                        Sedang mengetik...
                     </div>
                </div>
            `;
            history.scrollTop = history.scrollHeight;

            const systemPrompt = "Kamu adalah Flow, AI Visual Designer dari FlowPict. Tugasmu: 1. Membantu user menggunakan fitur FlowPict (Magic Content, Banner, Ads, dll). 2. Memberikan ide visual/konsep foto untuk bisnis F&B. 3. Menjawab dengan ramah, santai, gunakan sapaan 'Kak'. Jangan halusinasi fitur yang tidak ada.";

            const reply = await callGeminiTextAPI(msg, systemPrompt);

            // Remove loading and add response
            document.getElementById(loadingId).remove();

            // Format bold text **text** to <b>text</b>
            const formattedReply = reply.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>').replace(/\n/g, '<br>');

            history.innerHTML += `
                <div class="flex gap-3">
                     <div class="w-8 h-8 rounded-full bg-purple-100 flex items-center justify-center text-purple-600 text-xs font-bold shrink-0">Flow</div>
                     <div class="bg-white p-3 rounded-2xl rounded-tl-none shadow-sm text-sm text-slate-600 max-w-[80%]">
                        ${formattedReply}
                     </div>
                </div>
            `;
            history.scrollTop = history.scrollHeight;
        };

        // Utility: Copy to Clipboard
        window.copyToClipboard = function (text) {
            if (!navigator.clipboard) {
                const ta = document.createElement("textarea");
                ta.value = text;
                document.body.appendChild(ta);
                ta.select();
                document.execCommand("copy");
                document.body.removeChild(ta);
                alert("Copied to clipboard!");
                return;
            }
            navigator.clipboard.writeText(text).then(() => {
                alert("JSON Copied to Clipboard!");
            }).catch(err => {
                console.error("Failed to copy:", err);
                alert("Gagal copy text.");
            });
        };

        init();
    </script>
</body>

</html>

)